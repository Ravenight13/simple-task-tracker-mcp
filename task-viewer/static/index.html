<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Viewer</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            status: {
              todo: '#94a3b8',      // slate-400
              in_progress: '#3b82f6', // blue-500
              done: '#10b981',       // green-500
              blocked: '#ef4444',    // red-500
            },
            priority: {
              low: '#94a3b8',       // slate-400
              medium: '#f59e0b',    // amber-500
              high: '#ef4444',      // red-500
            }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'sans-serif'],
          },
        }
      },
      darkMode: 'class',
    }
  </script>

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- API Configuration -->
  <script src="js/config.js"></script>

  <!-- Critical CSS for loading states -->
  <style>
    /* Hide elements with x-cloak until Alpine initializes */
    [x-cloak] { display: none !important; }

    /* Skeleton loading animation */
    .skeleton {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Line clamp utility for truncating text */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    .sr-only:focus {
      position: static;
      width: auto;
      height: auto;
      padding: 0;
      margin: 0;
      overflow: visible;
      clip: auto;
      white-space: normal;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans antialiased">
  <!-- Skip to main content link (accessibility) -->
  <a
    href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:p-4 focus:bg-blue-600 focus:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
  >
    Skip to main content
  </a>

  <!-- Main Alpine.js App -->
  <div x-data="taskViewer()" x-init="init()" x-cloak>

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo/Title -->
          <div class="flex items-center">
            <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">
              Task Viewer
            </h1>
          </div>

          <!-- Project Selector -->
          <div class="flex-1 max-w-md mx-8" x-data="{ open: false }">
            <div class="relative">
              <button
                @click="open = !open"
                class="w-full px-4 py-2 text-left bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                :aria-expanded="open"
                aria-haspopup="listbox"
              >
                <span x-text="currentProject?.friendly_name || currentProject?.workspace_path?.split('/').pop() || 'Select Project'" class="block truncate"></span>
                <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>

              <div
                x-show="open"
                @click.away="open = false"
                x-transition:enter="transition ease-out duration-100"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-75"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
                class="absolute z-10 mt-2 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-60 overflow-auto"
                role="listbox"
              >
                <template x-for="project in projects" :key="project.id">
                  <button
                    @click="selectProject(project); open = false"
                    class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors"
                    :class="{ 'bg-blue-50 dark:bg-blue-900': currentProject?.id === project.id }"
                    role="option"
                    :aria-selected="currentProject?.id === project.id"
                  >
                    <div class="font-medium" x-text="project.friendly_name || project.workspace_path?.split('/').pop()"></div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 truncate" x-text="project.workspace_path"></div>
                  </button>
                </template>
              </div>
            </div>
          </div>

          <!-- API Key Status -->
          <div class="flex items-center gap-3">
            <button
              @click="showApiKeyModal = true"
              class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400 transition-colors"
              :class="{ 'text-green-600 dark:text-green-400': apiKey, 'text-red-600 dark:text-red-400': !apiKey }"
              :title="apiKey ? 'API Key Configured' : 'Configure API Key'"
            >
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Filters Bar -->
    <div class="sticky top-16 z-30 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <!-- Status chips with counts -->
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Status:</span>

          <template x-for="status in ['all', 'todo', 'in_progress', 'done', 'blocked']" :key="status">
            <button
              @click="statusFilter = status; applyFilters()"
              class="px-3 py-1 rounded-full text-sm font-medium transition-colors"
              :class="statusFilter === status
                ? 'bg-blue-600 text-white'
                : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600'"
              :aria-pressed="statusFilter === status"
            >
              <span x-text="status === 'all' ? 'All' : status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
              <span
                class="ml-1 opacity-75"
                x-text="`(${status === 'all' ? statusCounts.total : (statusCounts[status] || 0)})`"
              ></span>
            </button>
          </template>
        </div>

        <!-- Search and filters row -->
        <div class="flex flex-col sm:flex-row gap-3">
          <!-- Search input -->
          <div class="flex-1">
            <input
              type="text"
              x-model.debounce.300ms="searchQuery"
              @input="applyFilters()"
              placeholder="Search tasks..."
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
              aria-label="Search tasks"
            />
          </div>

          <!-- Priority filter -->
          <div class="relative" x-data="{ open: false }">
            <button
              @click="open = !open"
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
              :aria-expanded="open"
            >
              Priority: <span x-text="priorityFilter === 'all' ? 'All' : priorityFilter.charAt(0).toUpperCase() + priorityFilter.slice(1)"></span>
            </button>

            <div
              x-show="open"
              @click.away="open = false"
              x-transition
              class="absolute right-0 mt-2 w-40 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-10"
            >
              <template x-for="priority in ['all', 'low', 'medium', 'high']" :key="priority">
                <button
                  @click="priorityFilter = priority; applyFilters(); open = false"
                  class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 transition-colors"
                  :class="{ 'bg-blue-50 dark:bg-blue-900': priorityFilter === priority }"
                >
                  <span x-text="priority === 'all' ? 'All' : priority.charAt(0).toUpperCase() + priority.slice(1)"></span>
                </button>
              </template>
            </div>
          </div>

          <!-- Sort dropdown -->
          <div class="relative" x-data="{ open: false }">
            <button
              @click="open = !open"
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
              :aria-expanded="open"
            >
              Sort
            </button>

            <div
              x-show="open"
              @click.away="open = false"
              x-transition
              class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-10"
            >
              <template x-for="option in [
                { value: 'created_desc', label: 'Newest first' },
                { value: 'created_asc', label: 'Oldest first' },
                { value: 'priority_desc', label: 'Priority (high to low)' },
                { value: 'title_asc', label: 'Title (A-Z)' }
              ]" :key="option.value">
                <button
                  @click="sortBy = option.value; applyFilters(); open = false"
                  class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 transition-colors"
                  :class="{ 'bg-blue-50 dark:bg-blue-900': sortBy === option.value }"
                >
                  <span x-text="option.label"></span>
                </button>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- Live region for screen reader announcements -->
      <div
        role="status"
        aria-live="polite"
        aria-atomic="true"
        class="sr-only"
      >
        <span x-text="`Showing ${filteredTasks.length} of ${tasks.length} tasks`"></span>
      </div>

      <!-- Loading State -->
      <div x-show="loading" class="space-y-4">
        <div class="flex justify-center items-center py-12">
          <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="ml-2 text-gray-600 dark:text-gray-400">Loading tasks...</span>
        </div>
      </div>

      <!-- Error State -->
      <div x-show="error && !loading" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
        <div class="flex items-start">
          <svg class="h-5 w-5 text-red-400 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error loading tasks</h3>
            <p class="mt-1 text-sm text-red-700 dark:text-red-300" x-text="error"></p>
            <button
              @click="loadTasks()"
              class="mt-3 px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors"
            >
              Retry
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div x-show="!loading && !error && filteredTasks.length === 0" class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">No tasks found</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
          <template x-if="searchQuery || statusFilter !== 'all' || priorityFilter !== 'all'">
            <span>Try adjusting your filters</span>
          </template>
          <template x-if="!searchQuery && statusFilter === 'all' && priorityFilter === 'all'">
            <span>This project has no tasks yet</span>
          </template>
        </p>
      </div>

      <!-- Task Cards Grid -->
      <div
        x-show="!loading && !error && filteredTasks.length > 0"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
      >
        <template x-for="task in filteredTasks" :key="task.id">
          <div
            @click="openTaskDetail(task)"
            class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 p-4 border border-gray-200 dark:border-gray-700 cursor-pointer hover:border-blue-400 dark:hover:border-blue-600"
            role="button"
            tabindex="0"
            @keydown.enter="openTaskDetail(task)"
            @keydown.space.prevent="openTaskDetail(task)"
          >
            <!-- Header: Title + Status Badge -->
            <div class="flex items-start justify-between gap-3">
              <h3 class="flex-1 font-semibold text-gray-900 dark:text-gray-100 leading-snug" x-text="task.title"></h3>

              <span
                class="flex-shrink-0 px-2.5 py-0.5 rounded-full text-xs font-medium"
                :class="{
                  'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200': task.status === 'todo',
                  'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': task.status === 'in_progress',
                  'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': task.status === 'done',
                  'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': task.status === 'blocked'
                }"
                x-text="task.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())"
              ></span>
            </div>

            <!-- Description (truncated) -->
            <p
              class="mt-2 text-sm text-gray-600 dark:text-gray-400 line-clamp-2"
              x-text="task.description || 'No description provided'"
            ></p>

            <!-- Footer: Priority + Metadata -->
            <div class="mt-3 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <!-- Priority badge -->
                <span
                  class="px-2 py-0.5 rounded text-xs font-medium"
                  :class="{
                    'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300': task.priority === 'low',
                    'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200': task.priority === 'medium',
                    'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': task.priority === 'high'
                  }"
                  x-text="task.priority.charAt(0).toUpperCase() + task.priority.slice(1)"
                ></span>

                <!-- Tags (if present) -->
                <span
                  x-show="task.tags"
                  class="text-xs text-gray-500 dark:text-gray-400 truncate"
                  x-text="task.tags?.split(' ')[0]"
                ></span>
              </div>

              <!-- Created date -->
              <span class="text-xs text-gray-500 dark:text-gray-400" x-text="formatRelativeTime(task.created_at)"></span>
            </div>
          </div>
        </template>
      </div>
    </main>

    <!-- Task Detail Modal -->
    <div
      x-show="showModal"
      x-cloak
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 overflow-y-auto"
      @click.self="closeModal()"
      role="dialog"
      aria-modal="true"
      :aria-labelledby="selectedTask ? 'modal-title-' + selectedTask.id : ''"
    >
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black bg-opacity-50"></div>

      <!-- Modal content -->
      <div class="flex min-h-full items-center justify-center p-4">
        <div
          x-show="showModal"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
          x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
          x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
          x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
          class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full p-6"
          @click.stop
          x-trap.noscroll="showModal"
        >
          <!-- Close button -->
          <button
            @click="closeModal()"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded"
            aria-label="Close task details"
          >
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>

          <!-- Modal content (if task selected) -->
          <template x-if="selectedTask">
            <div>
              <h2
                :id="'modal-title-' + selectedTask.id"
                class="text-2xl font-bold text-gray-900 dark:text-gray-100 pr-8"
                x-text="selectedTask.title"
              ></h2>

              <div class="mt-4 flex gap-2 flex-wrap">
                <span
                  class="px-3 py-1 text-sm font-medium rounded-full"
                  :class="{
                    'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200': selectedTask.status === 'todo',
                    'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': selectedTask.status === 'in_progress',
                    'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': selectedTask.status === 'done',
                    'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': selectedTask.status === 'blocked'
                  }"
                  x-text="selectedTask.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())"
                ></span>

                <span
                  class="px-3 py-1 text-sm font-medium rounded"
                  :class="{
                    'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300': selectedTask.priority === 'low',
                    'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200': selectedTask.priority === 'medium',
                    'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': selectedTask.priority === 'high'
                  }"
                  x-text="selectedTask.priority.charAt(0).toUpperCase() + selectedTask.priority.slice(1)"
                ></span>
              </div>

              <div class="mt-6" x-show="selectedTask.description">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Description</h3>
                <p class="mt-2 text-gray-600 dark:text-gray-400 whitespace-pre-wrap" x-text="selectedTask.description || 'No description'"></p>
              </div>

              <!-- Blocker reason (if blocked) -->
              <div class="mt-6" x-show="selectedTask.status === 'blocked' && selectedTask.blocker_reason">
                <h3 class="text-sm font-semibold text-red-700 dark:text-red-300">Blocker Reason</h3>
                <p class="mt-2 text-red-600 dark:text-red-400" x-text="selectedTask.blocker_reason"></p>
              </div>

              <!-- Metadata grid -->
              <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                <div>
                  <span class="font-semibold text-gray-700 dark:text-gray-300">Created:</span>
                  <span class="ml-2 text-gray-600 dark:text-gray-400" x-text="formatDate(selectedTask.created_at)"></span>
                </div>

                <div x-show="selectedTask.updated_at !== selectedTask.created_at">
                  <span class="font-semibold text-gray-700 dark:text-gray-300">Updated:</span>
                  <span class="ml-2 text-gray-600 dark:text-gray-400" x-text="formatDate(selectedTask.updated_at)"></span>
                </div>

                <div x-show="selectedTask.completed_at">
                  <span class="font-semibold text-gray-700 dark:text-gray-300">Completed:</span>
                  <span class="ml-2 text-gray-600 dark:text-gray-400" x-text="formatDate(selectedTask.completed_at)"></span>
                </div>

                <div x-show="selectedTask.tags">
                  <span class="font-semibold text-gray-700 dark:text-gray-300">Tags:</span>
                  <span class="ml-2 text-gray-600 dark:text-gray-400" x-text="selectedTask.tags"></span>
                </div>

                <div x-show="selectedTask.parent_task_id" class="sm:col-span-2">
                  <span class="font-semibold text-gray-700 dark:text-gray-300">Parent Task:</span>
                  <span class="ml-2 text-gray-600 dark:text-gray-400" x-text="'#' + selectedTask.parent_task_id"></span>
                </div>
              </div>

              <!-- File references -->
              <div class="mt-6" x-show="selectedTask.file_references && JSON.parse(selectedTask.file_references || '[]').length > 0">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">File References</h3>
                <ul class="mt-2 space-y-1">
                  <template x-for="file in JSON.parse(selectedTask.file_references || '[]')" :key="file">
                    <li class="text-sm text-blue-600 dark:text-blue-400 font-mono" x-text="file"></li>
                  </template>
                </ul>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- API Key Configuration Modal -->
    <div
      x-show="showApiKeyModal"
      x-cloak
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 overflow-y-auto"
      @click.self="showApiKeyModal = false"
      role="dialog"
      aria-modal="true"
      aria-labelledby="api-key-modal-title"
    >
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black bg-opacity-50"></div>

      <!-- Modal content -->
      <div class="flex min-h-full items-center justify-center p-4">
        <div
          x-show="showApiKeyModal"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
          x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
          x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
          x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
          class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6"
          @click.stop
        >
          <h2 id="api-key-modal-title" class="text-xl font-bold text-gray-900 dark:text-gray-100">Configure API Key</h2>

          <div class="mt-4">
            <label for="api-key-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              API Key
            </label>
            <input
              id="api-key-input"
              type="password"
              x-model="apiKeyInput"
              placeholder="Enter your API key"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div class="mt-6 flex gap-3">
            <button
              @click="saveApiKey()"
              class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
            >
              Save
            </button>
            <button
              @click="showApiKeyModal = false"
              class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Alpine.js Application Logic -->
  <script>
    function taskViewer() {
      return {
        // State
        apiKey: API_CONFIG.getApiKey(),
        apiKeyInput: '',
        showApiKeyModal: false,
        projects: [],
        currentProject: null,
        tasks: [],
        filteredTasks: [],
        selectedTask: null,

        // Filters
        statusFilter: 'all',
        priorityFilter: 'all',
        searchQuery: '',
        sortBy: 'created_desc',

        // UI State
        loading: false,
        error: null,
        showModal: false,

        // Lifecycle
        async init() {
          // Check for API key
          if (!this.apiKey) {
            this.showApiKeyModal = true;
            return;
          }

          await this.loadProjects();
          if (this.projects.length > 0) {
            this.currentProject = this.projects[0];
            await this.loadTasks();
          }
        },

        // API Methods
        async loadProjects() {
          this.loading = true;
          this.error = null;

          try {
            const response = await fetch(`${API_CONFIG.baseUrl}/projects`, {
              headers: { 'X-API-Key': this.apiKey }
            });

            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('Invalid API key. Please check your configuration.');
              }
              throw new Error(`Failed to load projects: ${response.statusText}`);
            }

            const data = await response.json();
            this.projects = data.projects || [];
          } catch (err) {
            this.error = err.message;
            console.error('Error loading projects:', err);
          } finally {
            this.loading = false;
          }
        },

        async loadTasks() {
          if (!this.currentProject) return;

          this.loading = true;
          this.error = null;

          try {
            const params = new URLSearchParams({
              project_id: this.currentProject.id,
            });

            const response = await fetch(`${API_CONFIG.baseUrl}/tasks?${params}`, {
              headers: { 'X-API-Key': this.apiKey }
            });

            if (!response.ok) {
              throw new Error(`Failed to load tasks: ${response.statusText}`);
            }

            const data = await response.json();
            this.tasks = data.tasks || [];
            this.applyFilters();
          } catch (err) {
            this.error = err.message;
            console.error('Error loading tasks:', err);
          } finally {
            this.loading = false;
          }
        },

        async selectProject(project) {
          this.currentProject = project;
          await this.loadTasks();
        },

        // Filter Methods (client-side for instant response)
        applyFilters() {
          let filtered = [...this.tasks];

          // Status filter
          if (this.statusFilter !== 'all') {
            filtered = filtered.filter(t => t.status === this.statusFilter);
          }

          // Priority filter
          if (this.priorityFilter !== 'all') {
            filtered = filtered.filter(t => t.priority === this.priorityFilter);
          }

          // Search filter
          if (this.searchQuery.trim()) {
            const query = this.searchQuery.toLowerCase();
            filtered = filtered.filter(t =>
              t.title.toLowerCase().includes(query) ||
              (t.description && t.description.toLowerCase().includes(query)) ||
              (t.tags && t.tags.toLowerCase().includes(query))
            );
          }

          // Sort
          filtered.sort((a, b) => {
            switch (this.sortBy) {
              case 'created_desc':
                return new Date(b.created_at) - new Date(a.created_at);
              case 'created_asc':
                return new Date(a.created_at) - new Date(b.created_at);
              case 'priority_desc':
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
              case 'title_asc':
                return a.title.localeCompare(b.title);
              default:
                return 0;
            }
          });

          this.filteredTasks = filtered;
        },

        // UI Methods
        openTaskDetail(task) {
          this.selectedTask = task;
          this.showModal = true;
        },

        closeModal() {
          this.showModal = false;
          setTimeout(() => {
            this.selectedTask = null;
          }, 300);
        },

        saveApiKey() {
          if (this.apiKeyInput.trim()) {
            this.apiKey = this.apiKeyInput.trim();
            API_CONFIG.setApiKey(this.apiKey);
            this.showApiKeyModal = false;
            this.apiKeyInput = '';
            this.init();
          }
        },

        // Computed properties
        get statusCounts() {
          return {
            total: this.tasks.length,
            todo: this.tasks.filter(t => t.status === 'todo').length,
            in_progress: this.tasks.filter(t => t.status === 'in_progress').length,
            done: this.tasks.filter(t => t.status === 'done').length,
            blocked: this.tasks.filter(t => t.status === 'blocked').length,
          };
        },

        // Helper Functions
        formatDate(dateString) {
          if (!dateString) return 'N/A';
          const date = new Date(dateString);
          return new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }).format(date);
        },

        formatRelativeTime(dateString) {
          if (!dateString) return 'N/A';
          const date = new Date(dateString);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);

          if (diffMins < 1) return 'Just now';
          if (diffMins < 60) return `${diffMins}m ago`;
          if (diffHours < 24) return `${diffHours}h ago`;
          if (diffDays < 7) return `${diffDays}d ago`;
          return this.formatDate(dateString);
        }
      }
    }
  </script>
</body>
</html>
