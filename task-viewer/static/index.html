<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Viewer</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            status: {
              todo: '#94a3b8',      // slate-400
              in_progress: '#3b82f6', // blue-500
              done: '#10b981',       // green-500
              blocked: '#ef4444',    // red-500
            },
            priority: {
              low: '#94a3b8',       // slate-400
              medium: '#f59e0b',    // amber-500
              high: '#ef4444',      // red-500
            }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'sans-serif'],
          },
        }
      },
      darkMode: 'class',
    }
  </script>

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Alpine.js with Focus and Collapse plugins -->
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- API Configuration -->
  <script src="/static/js/config.js"></script>

  <!-- Critical CSS for loading states -->
  <style>
    /* Hide elements with x-cloak until Alpine initializes */
    [x-cloak] { display: none !important; }

    /* Skeleton loading animation */
    .skeleton {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Line clamp utility for truncating text */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    .sr-only:focus {
      position: static;
      width: auto;
      height: auto;
      padding: 0;
      margin: 0;
      overflow: visible;
      clip: auto;
      white-space: normal;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans antialiased">
  <!-- Skip to main content link (accessibility) -->
  <a
    href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:p-4 focus:bg-blue-600 focus:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
  >
    Skip to main content
  </a>

  <!-- Main Alpine.js App -->
  <div x-data="taskViewer()" x-init="init()" x-cloak>

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo/Title -->
          <div class="flex items-center">
            <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">
              Task Viewer
            </h1>
          </div>

          <!-- Project Selector -->
          <div class="flex-1 max-w-md mx-8" x-data="{ open: false }">
            <div class="relative">
              <button
                @click="open = !open"
                class="w-full px-4 py-2 text-left bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                :aria-expanded="open"
                aria-haspopup="listbox"
              >
                <span x-text="currentProject?.friendly_name || (currentProject?.workspace_path ? currentProject.workspace_path.split('/').pop() : 'Select Project')" class="block truncate"></span>
                <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>

              <div
                x-show="open"
                @click.away="open = false"
                x-transition:enter="transition ease-out duration-100"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-75"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
                class="absolute z-10 mt-2 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-60 overflow-auto"
                role="listbox"
              >
                <template x-for="project in projects" :key="project.id">
                  <button
                    @click="selectProject(project); open = false"
                    class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors"
                    :class="{ 'bg-blue-50 dark:bg-blue-900': currentProject?.id === project.id }"
                    role="option"
                    :aria-selected="currentProject?.id === project.id"
                  >
                    <div class="font-medium" x-text="project?.friendly_name || (project?.workspace_path ? project.workspace_path.split('/').pop() : 'Unknown')"></div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 truncate" x-text="project?.workspace_path || ''"></div>
                  </button>
                </template>
              </div>
            </div>
          </div>

          <!-- Actions: Refresh + API Key Status -->
          <div class="flex items-center gap-3">
            <!-- Refresh Button -->
            <button
              @click="refreshAllData()"
              :disabled="refreshing"
              class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              :class="{ 'animate-spin': refreshing }"
              :title="refreshing ? 'Refreshing...' : 'Refresh all data'"
              aria-label="Refresh all data"
            >
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>

            <!-- API Key Status -->
            <button
              @click="showApiKeyModal = true"
              class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400 transition-colors"
              :class="{ 'text-green-600 dark:text-green-400': apiKey, 'text-red-600 dark:text-red-400': !apiKey }"
              :title="apiKey ? 'API Key Configured' : 'Configure API Key'"
            >
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="sticky top-16 z-30 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <nav class="flex space-x-8" aria-label="Main tabs">
          <!-- Tasks Tab -->
          <button
            @click="switchTab('tasks')"
            class="relative py-4 px-1 text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            :class="{
              'text-blue-600 dark:text-blue-400': activeTab === 'tasks',
              'text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300': activeTab !== 'tasks'
            }"
            :aria-current="activeTab === 'tasks' ? 'page' : undefined"
          >
            <span class="flex items-center gap-2">
              Tasks
              <span
                x-show="statusCounts.total > 0"
                x-text="statusCounts.total"
                class="inline-flex items-center justify-center min-w-[1.5rem] h-6 px-2 text-xs font-semibold rounded-full transition-colors"
                :class="{
                  'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300': activeTab === 'tasks',
                  'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300': activeTab !== 'tasks'
                }"
              ></span>
            </span>
            <!-- Active indicator -->
            <span
              x-show="activeTab === 'tasks'"
              class="absolute bottom-0 left-0 right-0 h-0.5 bg-blue-600 dark:bg-blue-400"
              aria-hidden="true"
            ></span>
          </button>

          <!-- Entities Tab -->
          <button
            @click="switchTab('entities')"
            class="relative py-4 px-1 text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            :class="{
              'text-blue-600 dark:text-blue-400': activeTab === 'entities',
              'text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300': activeTab !== 'entities'
            }"
            :aria-current="activeTab === 'entities' ? 'page' : undefined"
          >
            <span class="flex items-center gap-2">
              Entities
              <span
                x-show="entityStats.total > 0"
                x-text="entityStats.total"
                class="inline-flex items-center justify-center min-w-[1.5rem] h-6 px-2 text-xs font-semibold rounded-full transition-colors"
                :class="{
                  'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300': activeTab === 'entities',
                  'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300': activeTab !== 'entities'
                }"
              ></span>
            </span>
            <!-- Active indicator -->
            <span
              x-show="activeTab === 'entities'"
              class="absolute bottom-0 left-0 right-0 h-0.5 bg-blue-600 dark:bg-blue-400"
              aria-hidden="true"
            ></span>
          </button>
        </nav>
      </div>
    </div>

    <!-- Filters Bar (Tasks Only) -->
    <div x-show="activeTab === 'tasks'" class="sticky top-[120px] z-20 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <!-- Tag Filter -->
        <div class="flex flex-wrap items-center gap-2 mb-3" x-data="{ open: false }">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Filter by Tag:</span>

          <div class="relative">
            <button
              @click="open = !open"
              class="px-4 py-1.5 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors flex items-center gap-2"
              :class="{ 'ring-2 ring-blue-500': selectedTag }"
              :aria-expanded="open"
              aria-haspopup="listbox"
            >
              <template x-if="selectedTag">
                <span class="flex items-center gap-2">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                    <span x-text="selectedTag"></span>
                  </span>
                  <span class="text-gray-400">|</span>
                  <span class="text-xs text-gray-500 dark:text-gray-400" x-text="`${(tags.find(t => t.tag === selectedTag)?.count || 0)} tasks`"></span>
                </span>
              </template>
              <template x-if="!selectedTag">
                <span class="text-gray-700 dark:text-gray-300">All Tags</span>
              </template>
              <svg class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>

            <div
              x-show="open"
              @click.away="open = false"
              x-transition:enter="transition ease-out duration-100"
              x-transition:enter-start="opacity-0 scale-95"
              x-transition:enter-end="opacity-100 scale-100"
              x-transition:leave="transition ease-in duration-75"
              x-transition:leave-start="opacity-100 scale-100"
              x-transition:leave-end="opacity-0 scale-95"
              class="absolute z-10 mt-2 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-80 overflow-auto"
              role="listbox"
            >
              <!-- "All Tags" option -->
              <button
                @click="selectTag(null); open = false"
                class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors"
                :class="{ 'bg-blue-50 dark:bg-blue-900': !selectedTag }"
                role="option"
                :aria-selected="!selectedTag"
              >
                <div class="font-medium">All Tags</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Show all tasks</div>
              </button>

              <!-- Divider -->
              <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>

              <!-- Tag list -->
              <template x-if="tags.length > 0">
                <div>
                  <template x-for="tagItem in tags" :key="tagItem.tag">
                    <button
                      @click="selectTag(tagItem.tag); open = false"
                      class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                      :class="{ 'bg-blue-50 dark:bg-blue-900': selectedTag === tagItem.tag }"
                      role="option"
                      :aria-selected="selectedTag === tagItem.tag"
                    >
                      <div class="flex items-center justify-between gap-2">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                          <span x-text="tagItem.tag"></span>
                        </span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">
                          <span x-text="tagItem.count"></span> task<span x-show="tagItem.count !== 1">s</span>
                        </span>
                      </div>
                    </button>
                  </template>
                </div>
              </template>

              <!-- Empty state -->
              <template x-if="tags.length === 0">
                <div class="px-4 py-6 text-center text-sm text-gray-500 dark:text-gray-400">
                  <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                  </svg>
                  <div>No tags available</div>
                  <div class="text-xs mt-1">Tasks with tags will appear here</div>
                </div>
              </template>
            </div>
          </div>

          <!-- Clear Tag Filter Button -->
          <button
            x-show="selectedTag"
            @click="selectTag(null)"
            class="px-3 py-1 rounded-full text-sm font-medium transition-colors bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center gap-1"
            title="Clear tag filter"
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            <span>Clear Tag</span>
          </button>
        </div>

        <!-- Smart Filters -->
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Quick Filters:</span>

          <button
            @click="applySmartFilter('my-focus')"
            class="px-3 py-1 rounded-full text-sm font-medium transition-colors flex items-center gap-1"
            :class="activeSmartFilter === 'my-focus'
              ? 'bg-purple-600 text-white'
              : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-purple-50 dark:hover:bg-gray-600'"
            title="High priority + In Progress tasks"
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span>My Focus</span>
          </button>

          <button
            @click="applySmartFilter('ready-to-work')"
            class="px-3 py-1 rounded-full text-sm font-medium transition-colors flex items-center gap-1"
            :class="activeSmartFilter === 'ready-to-work'
              ? 'bg-green-600 text-white'
              : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-green-50 dark:hover:bg-gray-600'"
            title="Todo tasks with no blockers"
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Ready to Work</span>
          </button>

          <button
            @click="applySmartFilter('blocked-work')"
            class="px-3 py-1 rounded-full text-sm font-medium transition-colors flex items-center gap-1"
            :class="activeSmartFilter === 'blocked-work'
              ? 'bg-red-600 text-white'
              : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-red-50 dark:hover:bg-gray-600'"
            title="Blocked tasks OR tasks blocking others"
          >
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" />
            </svg>
            <span>Blocked Work</span>
          </button>

          <button
            @click="applySmartFilter('recently-completed')"
            class="px-3 py-1 rounded-full text-sm font-medium transition-colors flex items-center gap-1"
            :class="activeSmartFilter === 'recently-completed'
              ? 'bg-blue-600 text-white'
              : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-600'"
            title="Recently completed tasks"
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
            </svg>
            <span>Recently Completed</span>
          </button>

          <button
            @click="applySmartFilter('parent-tasks')"
            class="px-3 py-1 rounded-full text-sm font-medium transition-colors flex items-center gap-1"
            :class="activeSmartFilter === 'parent-tasks'
              ? 'bg-cyan-600 text-white'
              : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-cyan-50 dark:hover:bg-gray-600'"
            title="Only show parent tasks (no subtasks)"
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
            </svg>
            <span>Parent Tasks</span>
          </button>

          <button
            x-show="activeSmartFilter"
            @click="clearSmartFilter()"
            class="px-3 py-1 rounded-full text-sm font-medium transition-colors bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500"
            title="Clear smart filter"
          >
            <span>Clear Filter</span>
          </button>
        </div>

        <!-- Status chips with counts -->
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Status:</span>

          <template x-for="status in ['all', 'todo', 'in_progress', 'done', 'blocked', 'to_be_deleted']" :key="status">
            <button
              @click="statusFilter = status; if (activeSmartFilter && activeSmartFilter !== 'parent-tasks') activeSmartFilter = null; applyFilters()"
              class="px-3 py-1 rounded-full text-sm font-medium transition-colors"
              :class="statusFilter === status && (activeSmartFilter === 'parent-tasks' || !activeSmartFilter)
                ? 'bg-blue-600 text-white'
                : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600'"
              :aria-pressed="statusFilter === status"
            >
              <span x-text="status === 'all' ? 'All' : status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
              <span
                class="ml-1 opacity-75"
                x-text="`(${status === 'all' ? (statusCounts?.total || 0) : (statusCounts?.[status] || 0)})`"
              ></span>
            </button>
          </template>
        </div>

        <!-- Search and filters row -->
        <div class="flex flex-col sm:flex-row gap-3">
          <!-- Search input -->
          <div class="flex-1">
            <input
              type="text"
              x-model.debounce.300ms="searchQuery"
              @input="applyFilters()"
              placeholder="Search tasks..."
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
              aria-label="Search tasks"
            />
          </div>

          <!-- Priority filter -->
          <div class="relative" x-data="{ open: false }">
            <button
              @click="open = !open"
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
              :aria-expanded="open"
            >
              Priority: <span x-text="priorityFilter === 'all' ? 'All' : priorityFilter.charAt(0).toUpperCase() + priorityFilter.slice(1)"></span>
            </button>

            <div
              x-show="open"
              @click.away="open = false"
              x-transition
              class="absolute right-0 mt-2 w-40 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-10"
            >
              <template x-for="priority in ['all', 'low', 'medium', 'high']" :key="priority">
                <button
                  @click="priorityFilter = priority; applyFilters(); open = false"
                  class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 transition-colors"
                  :class="{ 'bg-blue-50 dark:bg-blue-900': priorityFilter === priority }"
                >
                  <span x-text="priority === 'all' ? 'All' : priority.charAt(0).toUpperCase() + priority.slice(1)"></span>
                </button>
              </template>
            </div>
          </div>

          <!-- Sort dropdown -->
          <div class="relative" x-data="{ open: false }">
            <button
              @click="open = !open"
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors flex items-center gap-2"
              :aria-expanded="open"
            >
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
              </svg>
              <span>Sort</span>
              <svg class="h-4 w-4" :class="{ 'rotate-180': sortOrder === 'desc' }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
              </svg>
            </button>

            <div
              x-show="open"
              @click.away="open = false"
              x-transition
              class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-10"
            >
              <div class="p-2 border-b border-gray-200 dark:border-gray-600">
                <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase px-2 py-1">Sort By</p>
              </div>
              <template x-for="option in [
                { value: 'priority', label: 'Priority' },
                { value: 'status', label: 'Status' },
                { value: 'created', label: 'Creation Date' },
                { value: 'title', label: 'Title' },
                { value: 'id', label: 'Task #' }
              ]" :key="option.value">
                <button
                  @click="setSortBy(option.value); open = false"
                  class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 transition-colors flex items-center justify-between"
                  :class="{ 'bg-blue-50 dark:bg-blue-900 text-blue-700 dark:text-blue-200': sortBy === option.value + '_' + sortOrder }"
                >
                  <span x-text="option.label"></span>
                  <svg x-show="sortBy === option.value + '_' + sortOrder" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                </button>
              </template>
              <div class="p-2 border-t border-gray-200 dark:border-gray-600">
                <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase px-2 py-1">Order</p>
              </div>
              <button
                @click="toggleSortOrder(); open = false"
                class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 transition-colors"
              >
                <span x-text="sortOrder === 'desc' ? '↓ Descending' : '↑ Ascending'"></span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- Tasks View -->
      <div x-show="activeTab === 'tasks'">
        <!-- Live region for screen reader announcements -->
        <div
          role="status"
          aria-live="polite"
          aria-atomic="true"
          class="sr-only"
        >
          <span x-text="`Showing ${(filteredTasks || []).length} of ${(tasks || []).length} tasks`"></span>
        </div>

        <!-- Loading State -->
      <div x-show="loading" class="space-y-4">
        <div class="flex justify-center items-center py-12">
          <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="ml-2 text-gray-600 dark:text-gray-400">Loading tasks...</span>
        </div>
      </div>

      <!-- Error State -->
      <div x-show="error && !loading" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
        <div class="flex items-start">
          <svg class="h-5 w-5 text-red-400 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error loading tasks</h3>
            <p class="mt-1 text-sm text-red-700 dark:text-red-300" x-text="error"></p>
            <button
              @click="loadTasks()"
              class="mt-3 px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors"
            >
              Retry
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div x-show="!loading && !error && (filteredTasks || []).length === 0" class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">No tasks found</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
          <template x-if="searchQuery || statusFilter !== 'all' || priorityFilter !== 'all' || activeSmartFilter">
            <span>Try adjusting your filters</span>
          </template>
          <template x-if="!searchQuery && statusFilter === 'all' && priorityFilter === 'all' && !activeSmartFilter">
            <span>This project has no tasks yet</span>
          </template>
        </p>
      </div>

      <!-- Task Cards Grid -->
      <div
        x-show="!loading && !error && (filteredTasks || []).length > 0"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
      >
        <template x-for="(task, index) in filteredTasks" :key="task.id">
          <div
            x-data="{ showPreview: false, hoverTimeout: null }"
            @click="openTaskDetail(task)"
            class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 p-4 border border-gray-200 dark:border-gray-700 cursor-pointer hover:border-blue-400 dark:hover:border-blue-600 relative"
            role="button"
            tabindex="0"
            @keydown.enter="openTaskDetail(task)"
            @keydown.space.prevent="openTaskDetail(task)"
          >
            <!-- Row 1: Task Title (Clean and Prominent) -->
            <div
              class="relative"
              @mouseenter="hoverTimeout = setTimeout(() => showPreview = true, 500)"
              @mouseleave="clearTimeout(hoverTimeout); showPreview = false"
            >
              <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 leading-tight pr-2" x-text="task?.title || 'Untitled'"></h3>

              <!-- Hover Preview Tooltip -->
              <div
                x-show="showPreview && task?.description"
                x-transition
                class="absolute z-50 top-full left-0 mt-2 w-80 bg-gray-900 dark:bg-gray-700 text-white dark:text-gray-100 text-sm rounded-lg shadow-lg p-3 pointer-events-none"
                style="max-width: calc(100vw - 2rem);"
              >
                <div class="font-semibold mb-1">Description Preview:</div>
                <div class="text-gray-200 dark:text-gray-300" x-text="(task?.description || '').substring(0, 200) + ((task?.description || '').length > 200 ? '...' : '')"></div>
              </div>
            </div>

            <!-- Row 2: Description (truncated) -->
            <p
              x-show="task?.description"
              class="mt-2 text-sm text-gray-600 dark:text-gray-400 line-clamp-2"
              x-text="task?.description"
            ></p>

            <!-- Row 3: Status + Priority Badges -->
            <div class="mt-3 flex items-center gap-2">
              <!-- Status Badge -->
              <span
                class="px-2.5 py-0.5 rounded-full text-xs font-medium"
                :class="{
                  'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200': task?.status === 'todo',
                  'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': task?.status === 'in_progress',
                  'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': task?.status === 'done',
                  'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': task?.status === 'blocked',
                  'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200': task?.status === 'to_be_deleted'
                }"
                x-text="task?.status ? task.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'"
              ></span>

              <!-- Priority badge -->
              <span
                class="px-2 py-0.5 rounded text-xs font-medium"
                :class="{
                  'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300': task?.priority === 'low',
                  'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200': task?.priority === 'medium',
                  'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': task?.priority === 'high'
                }"
                x-text="task?.priority ? task.priority.charAt(0).toUpperCase() + task.priority.slice(1) : 'N/A'"
              ></span>
            </div>

            <!-- Row 4: Position, Parent Task, Dependencies, Blocker Badges (Grouped) -->
            <div class="mt-2 flex flex-wrap items-center gap-2">
              <!-- Position Number Badge -->
              <div class="px-2 py-0.5 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded text-xs font-medium">
                <span x-text="'#' + (index + 1)"></span>
              </div>

              <!-- Parent Task Badge (if this is a subtask) -->
              <button
                x-show="task?.parent_task_id"
                @click.stop="openTaskById(task.parent_task_id)"
                class="flex items-center gap-1 px-2 py-0.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded text-xs font-medium border border-indigo-200 dark:border-indigo-700 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 cursor-pointer transition-colors"
                :title="`Click to view parent: ${getParentTask(task.parent_task_id)?.title || 'Task #' + task.parent_task_id}`"
              >
                <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                </svg>
                <span>Subtask of:</span>
                <span
                  x-text="getParentTask(task.parent_task_id)?.title || `Task #${task.parent_task_id}`"
                  class="font-semibold truncate max-w-[120px]"
                ></span>
              </button>

              <!-- Dependencies Badge -->
              <div
                x-show="task?.depends_on && (() => { try { return JSON.parse(task.depends_on || '[]').length > 0; } catch { return false; } })()"
                class="flex items-center gap-1 px-2 py-0.5 bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded text-xs font-medium border border-amber-200 dark:border-amber-700"
              >
                <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
                <span>Depends:</span>
                <template x-for="(depId, index) in (() => { try { return JSON.parse(task.depends_on || '[]'); } catch { return []; } })()" :key="depId">
                  <span class="font-semibold">
                    <button
                      @click.stop="openTaskById(depId)"
                      class="text-amber-700 dark:text-amber-400 hover:text-amber-900 dark:hover:text-amber-200 hover:underline cursor-pointer"
                      :title="`Click to view dependency #${depId}`"
                      x-text="'#' + depId"
                    ></button><span x-show="index < (() => { try { return JSON.parse(task.depends_on || '[]').length - 1; } catch { return 0; } })()">,</span>
                  </span>
                </template>
              </div>

              <!-- Blocker Indicator (Red) - Shows when this task blocks other tasks -->
              <div
                x-show="task?.is_blocker"
                class="flex items-center gap-1 px-2 py-0.5 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded text-xs font-medium border border-red-200 dark:border-red-700"
              >
                <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" />
                </svg>
                <span>Blocks <span x-text="(task?.blocks_task_ids || []).length"></span>:</span>
                <template x-for="(blockedId, index) in (task?.blocks_task_ids || [])" :key="blockedId">
                  <span class="font-semibold">
                    <button
                      @click.stop="openTaskById(blockedId)"
                      class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-200 hover:underline cursor-pointer"
                      :title="`Click to view blocked task #${blockedId}`"
                      x-text="'#' + blockedId"
                    ></button><span x-show="index < (task?.blocks_task_ids || []).length - 1">,</span>
                  </span>
                </template>
              </div>
            </div>

            <!-- Row 5: Subtasks Indicator -->
            <div
              x-show="countSubtasks(task) > 0"
              class="mt-2"
            >
              <button
                @click.stop="toggleSubtasks(task, $event)"
                class="flex items-center gap-1 px-2 py-1 bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 hover:bg-purple-100 dark:hover:bg-purple-900/50 rounded text-xs font-medium border border-purple-200 dark:border-purple-700 transition-colors"
                :class="{ 'bg-purple-100 dark:bg-purple-900/50': expandedSubtasks[task.id] }"
              >
                <svg class="h-3.5 w-3.5 transition-transform" :class="{ 'rotate-90': expandedSubtasks[task.id] }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                <span x-show="!expandedSubtasks[task.id]">Show <span x-text="countSubtasks(task)"></span> subtask<span x-show="countSubtasks(task) !== 1">s</span></span>
                <span x-show="expandedSubtasks[task.id]">Hide subtasks</span>
              </button>
            </div>

            <!-- Expanded Subtasks -->
            <div
              x-show="expandedSubtasks[task.id]"
              x-collapse
              class="mt-3"
            >
              <!-- Loading state -->
              <div x-show="loadingSubtasks[task.id]" class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Loading subtasks...</span>
              </div>

              <!-- Recursive subtask rendering -->
              <div x-html="renderSubtasksRecursive(subtasksCache[task.id] || [], 0)"></div>
            </div>

            <!-- Metadata Row -->
            <div class="mt-3 flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
              <div class="flex items-center gap-2">
                <!-- Tags (if present) -->
                <span
                  x-show="task?.tags"
                  class="truncate"
                  x-text="task?.tags?.split(' ')[0] || ''"
                ></span>
              </div>

              <!-- Created date -->
              <span x-text="formatRelativeTime(task?.created_at)"></span>
            </div>

            <!-- Quick Actions Bar -->
            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 flex items-center gap-2">
              <button
                @click="copyTaskId(task, $event)"
                class="flex items-center gap-1 px-2 py-1 text-xs text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors"
                title="Copy task ID to clipboard"
              >
                <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                </svg>
                <span>Copy ID</span>
              </button>

              <button
                @click="copyTaskDetails(task, $event)"
                class="flex items-center gap-1 px-2 py-1 text-xs text-gray-600 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded transition-colors"
                title="Copy task details to clipboard"
              >
                <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <span>Copy Details</span>
              </button>

              <button
                @click.stop="openDetailPage(task)"
                class="flex items-center gap-1 px-2 py-1 text-xs text-gray-600 dark:text-gray-400 hover:text-purple-600 dark:hover:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded transition-colors"
                title="View full details page"
              >
                <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                <span>Full Details</span>
              </button>

              <div class="flex-1"></div>

              <span class="text-xs text-gray-400 dark:text-gray-500">Task #<span x-text="task.id"></span></span>
            </div>
          </div>
        </template>
      </div>
      </div>
      <!-- End Tasks View -->

      <!-- Entities View -->
      <div x-show="activeTab === 'entities'">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Entities</h2>
          <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
            Manage files, vendors, and other entities linked to your tasks
          </p>
        </div>

        <!-- Entity Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Entities</p>
                <p class="mt-2 text-3xl font-semibold text-gray-900 dark:text-gray-100" x-text="entityStats.total"></p>
              </div>
              <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-lg">
                <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">File Entities</p>
                <div class="flex items-baseline gap-2">
                  <p class="mt-2 text-3xl font-semibold text-gray-900 dark:text-gray-100" x-text="entityStats.file"></p>
                  <p class="text-sm text-gray-500 dark:text-gray-400" x-text="'(' + calculatePercentage(entityStats.file, entityStats.total) + '%)'"></p>
                </div>
              </div>
              <div class="p-3 bg-green-100 dark:bg-green-900 rounded-lg">
                <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Other Entities</p>
                <div class="flex items-baseline gap-2">
                  <p class="mt-2 text-3xl font-semibold text-gray-900 dark:text-gray-100" x-text="entityStats.other"></p>
                  <p class="text-sm text-gray-500 dark:text-gray-400" x-text="'(' + calculatePercentage(entityStats.other, entityStats.total) + '%)'"></p>
                </div>
              </div>
              <div class="p-3 bg-purple-100 dark:bg-purple-900 rounded-lg">
                <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Top Tags Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700 mb-6">
          <h4 class="text-sm font-semibold mb-4 text-gray-700 dark:text-gray-300">Top Tags</h4>
          <template x-if="entityStats.top_tags && entityStats.top_tags.length > 0">
            <div class="space-y-2">
              <template x-for="tag in entityStats.top_tags.slice(0, 5)" :key="tag.tag">
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
                  <span class="text-gray-600 dark:text-gray-400 font-medium" x-text="tag.tag"></span>
                  <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full text-xs font-semibold" x-text="tag.count"></span>
                </div>
              </template>
            </div>
          </template>
          <template x-if="!entityStats.top_tags || entityStats.top_tags.length === 0">
            <p class="text-sm text-gray-500 dark:text-gray-400 italic">No tags found</p>
          </template>
        </div>

        <!-- Entity Search Bar -->
        <div class="mb-6">
          <div class="relative">
            <input
              type="text"
              x-model="entitySearch"
              @input.debounce.300ms="searchEntities()"
              placeholder="Search entities by name or identifier..."
              class="w-full pl-10 pr-20 py-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 transition-colors"
              aria-label="Search entities"
            />

            <!-- Search icon (left) -->
            <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400 dark:text-gray-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>

            <!-- Clear button (right) -->
            <button
              x-show="entitySearch"
              @click="clearEntitySearch()"
              class="absolute right-12 top-2.5 p-1.5 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors rounded-md hover:bg-gray-100 dark:hover:bg-gray-600"
              title="Clear search"
              aria-label="Clear search"
              x-cloak
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>

            <!-- Loading spinner -->
            <div
              x-show="searchLoading"
              class="absolute right-3 top-3.5"
              x-cloak
            >
              <svg class="animate-spin h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          </div>

          <!-- Search result count -->
          <p
            x-show="entitySearch && !searchLoading"
            class="text-sm text-gray-600 dark:text-gray-400 mt-2 ml-1"
            x-cloak
          >
            Found <span x-text="searchResultCount" class="font-semibold"></span>
            <span x-text="searchResultCount === 1 ? 'entity' : 'entities'"></span>
          </p>
        </div>

        <!-- Entity Filters Bar -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700 mb-6">
          <div class="flex flex-wrap items-center gap-4">
            <!-- Entity Type Filter -->
            <div class="flex-shrink-0">
              <label for="entity-type-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Type</label>
              <select
                id="entity-type-filter"
                x-model="entityFilters.type"
                @change="selectEntityType(entityFilters.type)"
                class="block w-40 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors"
              >
                <option value="">All Types</option>
                <option value="file">Files</option>
                <option value="other">Other</option>
              </select>
            </div>

            <!-- Tag Filter -->
            <div class="flex-shrink-0" x-data="{ open: false }">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tag</label>
              <div class="relative">
                <button
                  @click="open = !open"
                  class="w-48 px-4 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors flex items-center justify-between"
                  :class="{ 'ring-2 ring-blue-500': selectedEntityTag }"
                  :aria-expanded="open"
                  aria-haspopup="listbox"
                >
                  <template x-if="selectedEntityTag">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                      <span x-text="selectedEntityTag"></span>
                    </span>
                  </template>
                  <template x-if="!selectedEntityTag">
                    <span class="text-gray-700 dark:text-gray-300">All Tags</span>
                  </template>
                  <svg class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                  </svg>
                </button>

                <div
                  x-show="open"
                  @click.away="open = false"
                  x-transition:enter="transition ease-out duration-100"
                  x-transition:enter-start="opacity-0 scale-95"
                  x-transition:enter-end="opacity-100 scale-100"
                  x-transition:leave="transition ease-in duration-75"
                  x-transition:leave-start="opacity-100 scale-100"
                  x-transition:leave-end="opacity-0 scale-95"
                  class="absolute z-10 mt-2 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-80 overflow-auto"
                  role="listbox"
                  x-cloak
                >
                  <!-- "All Tags" option -->
                  <button
                    @click="selectEntityTag(null); open = false"
                    class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors"
                    :class="{ 'bg-blue-50 dark:bg-blue-900': !selectedEntityTag }"
                    role="option"
                    :aria-selected="!selectedEntityTag"
                  >
                    <div class="font-medium">All Tags</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Show all entities</div>
                  </button>

                  <!-- Divider -->
                  <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>

                  <!-- Tag list -->
                  <template x-if="entityTags.length > 0">
                    <div>
                      <template x-for="tagItem in entityTags" :key="tagItem.tag">
                        <button
                          @click="selectEntityTag(tagItem.tag); open = false"
                          class="block w-full px-4 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                          :class="{ 'bg-blue-50 dark:bg-blue-900': selectedEntityTag === tagItem.tag }"
                          role="option"
                          :aria-selected="selectedEntityTag === tagItem.tag"
                        >
                          <div class="flex items-center justify-between gap-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                              <span x-text="tagItem.tag"></span>
                            </span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">
                              <span x-text="tagItem.count"></span> <span x-show="tagItem.count === 1">entity</span><span x-show="tagItem.count !== 1">entities</span>
                            </span>
                          </div>
                        </button>
                      </template>
                    </div>
                  </template>

                  <!-- Empty state -->
                  <template x-if="entityTags.length === 0">
                    <div class="px-4 py-6 text-center text-sm text-gray-500 dark:text-gray-400">
                      <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                      </svg>
                      <div>No tags available</div>
                      <div class="text-xs mt-1">Entities with tags will appear here</div>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <!-- Active Filters Chips -->
            <div class="flex flex-wrap items-center gap-2 ml-auto">
              <template x-if="entityFilters.type || selectedEntityTag">
                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Filters:</span>
              </template>

              <template x-if="entityFilters.type">
                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                  Type: <span x-text="entityFilters.type === 'file' ? 'Files' : 'Other'"></span>
                  <button
                    @click="selectEntityType('')"
                    class="ml-1 hover:bg-blue-200 dark:hover:bg-blue-800 rounded-full p-0.5 transition-colors"
                    aria-label="Clear type filter"
                  >
                    <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </span>
              </template>

              <template x-if="selectedEntityTag">
                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                  Tag: <span x-text="selectedEntityTag"></span>
                  <button
                    @click="selectEntityTag(null)"
                    class="ml-1 hover:bg-blue-200 dark:hover:bg-blue-800 rounded-full p-0.5 transition-colors"
                    aria-label="Clear tag filter"
                  >
                    <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </span>
              </template>

              <!-- Clear All Filters Button -->
              <button
                x-show="entityFilters.type || selectedEntityTag"
                @click="clearEntityFilters()"
                class="px-3 py-1 rounded-full text-sm font-medium transition-colors bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center gap-1"
                title="Clear all filters"
                x-cloak
              >
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                <span>Clear All</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Entity Cards Grid -->
        <div id="entities-container" x-show="entities.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <template x-for="entity in entities" :key="entity.id">
            <div
              @click="openEntityModal(entity)"
              class="entity-card bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer p-4 border border-gray-200 dark:border-gray-700"
            >
              <!-- Type badge -->
              <div class="mb-2" x-html="getEntityTypeBadge(entity.entity_type)"></div>

              <!-- Name -->
              <h3
                class="font-semibold text-lg text-gray-900 dark:text-white truncate mb-1"
                :title="entity.name"
                x-text="entity.name"
              ></h3>

              <!-- Identifier -->
              <p
                x-show="entity.identifier"
                class="text-sm text-gray-600 dark:text-gray-400 truncate mb-2"
                :title="entity.identifier"
                x-text="entity.identifier"
              ></p>

              <!-- Tags -->
              <div x-show="entity.tags" class="flex flex-wrap gap-1 mt-2 mb-3">
                <template x-for="tag in (entity.tags || '').split(' ').filter(t => t)" :key="tag">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                    <span x-text="tag"></span>
                  </span>
                </template>
              </div>

              <!-- Linked tasks count -->
              <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                </svg>
                <span x-text="entity.linked_tasks_count || 0"></span>
                <span x-text="(entity.linked_tasks_count || 0) === 1 ? 'linked task' : 'linked tasks'"></span>
              </div>
            </div>
          </template>
        </div>

        <!-- Entity Pagination Controls -->
        <div
          x-show="entities.length > 0 && entityTotalPages > 1"
          id="entity-pagination"
          class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-6 p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700"
        >
          <!-- Results summary -->
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Showing
            <span class="font-semibold" x-text="entityPaginationStart"></span>-<span class="font-semibold" x-text="entityPaginationEnd"></span>
            of
            <span class="font-semibold" x-text="entityTotalEntities"></span>
            entities
          </p>

          <!-- Page navigation -->
          <div class="flex items-center gap-2">
            <button
              @click="entityPreviousPage()"
              :disabled="entityCurrentPage === 1"
              :class="entityCurrentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700'"
              class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm font-medium text-gray-700 dark:text-gray-300 transition-colors"
              aria-label="Previous page"
            >
              Previous
            </button>

            <!-- Page numbers (show max 5) -->
            <template x-for="page in entityVisiblePages" :key="page">
              <button
                @click="entityGoToPage(page)"
                :class="entityCurrentPage === page ? 'bg-blue-500 text-white border-blue-500' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 border-gray-300 dark:border-gray-600'"
                class="px-3 py-1 border rounded text-sm font-medium transition-colors"
                :aria-label="'Go to page ' + page"
                :aria-current="entityCurrentPage === page ? 'page' : undefined"
                x-text="page"
              >
              </button>
            </template>

            <button
              @click="entityNextPage()"
              :disabled="entityCurrentPage >= entityTotalPages"
              :class="entityCurrentPage >= entityTotalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700'"
              class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm font-medium text-gray-700 dark:text-gray-300 transition-colors"
              aria-label="Next page"
            >
              Next
            </button>
          </div>

          <!-- Page size selector -->
          <div class="flex items-center gap-2">
            <label for="entity-page-size" class="text-sm text-gray-600 dark:text-gray-400">Per page:</label>
            <select
              id="entity-page-size"
              x-model.number="entityFilters.limit"
              @change="changeEntityPageSize()"
              class="border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>

        <!-- Empty State -->
        <div x-show="entities.length === 0" class="bg-white dark:bg-gray-800 rounded-lg shadow p-8 border border-gray-200 dark:border-gray-700 text-center">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
          <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-gray-100">No Entities Yet</h3>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            Create entities using the MCP tools to track files, vendors, and other resources
          </p>
        </div>
      </div>
      <!-- End Entities View -->
    </main>

    <!-- Task Detail Modal -->
    <div
      x-show="showModal"
      x-cloak
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 overflow-y-auto"
      @click.self="closeModal()"
      role="dialog"
      aria-modal="true"
      :aria-labelledby="selectedTask ? 'modal-title-' + (selectedTask?.id || 'task') : 'modal-title-task'"
    >
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black bg-opacity-50"></div>

      <!-- Modal content -->
      <div class="flex min-h-full items-center justify-center p-4">
        <div
          x-show="showModal"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
          x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
          x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
          x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
          class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full p-6"
          @click.stop
          x-trap.noscroll="showModal"
        >
          <!-- View Full Details button -->
          <button
            @click="closeModal(); openDetailPage(selectedTask)"
            class="absolute top-4 right-14 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded"
            title="View full details"
            aria-label="View full details"
          >
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </button>

          <!-- Close button -->
          <button
            @click="closeModal()"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded"
            aria-label="Close task details"
          >
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>

          <!-- Modal content (if task selected) -->
          <template x-if="selectedTask">
            <div>
              <h2
                :id="'modal-title-' + (selectedTask?.id || 'task')"
                class="text-2xl font-bold text-gray-900 dark:text-gray-100 pr-8"
                x-text="selectedTask?.title || 'Untitled'"
              ></h2>

              <div class="mt-4 flex gap-2 flex-wrap">
                <span
                  class="px-3 py-1 text-sm font-medium rounded-full"
                  :class="{
                    'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200': selectedTask?.status === 'todo',
                    'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': selectedTask?.status === 'in_progress',
                    'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': selectedTask?.status === 'done',
                    'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': selectedTask?.status === 'blocked',
                    'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200': selectedTask?.status === 'to_be_deleted'
                  }"
                  x-text="selectedTask?.status ? selectedTask.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'"
                ></span>

                <span
                  class="px-3 py-1 text-sm font-medium rounded"
                  :class="{
                    'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300': selectedTask?.priority === 'low',
                    'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200': selectedTask?.priority === 'medium',
                    'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': selectedTask?.priority === 'high'
                  }"
                  x-text="selectedTask?.priority ? selectedTask.priority.charAt(0).toUpperCase() + selectedTask.priority.slice(1) : 'N/A'"
                ></span>
              </div>

              <div class="mt-6" x-show="selectedTask?.description">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Description</h3>
                <p class="mt-2 text-gray-600 dark:text-gray-400 whitespace-pre-wrap" x-text="selectedTask?.description || 'No description'"></p>
              </div>

              <!-- Blocker reason (if this task is blocked) -->
              <div class="mt-6" x-show="selectedTask?.status === 'blocked' && selectedTask?.blocker_reason">
                <h3 class="text-sm font-semibold text-red-700 dark:text-red-300">Blocker Reason</h3>
                <p class="mt-2 text-red-600 dark:text-red-400" x-text="selectedTask?.blocker_reason || ''"></p>
              </div>

              <!-- Blocker info (if this task blocks other tasks) -->
              <div class="mt-6" x-show="selectedTask?.is_blocker && (selectedTask?.blocks_task_ids || []).length > 0">
                <h3 class="text-sm font-semibold text-red-700 dark:text-red-300">Blocking Tasks</h3>
                <p class="mt-2 text-red-600 dark:text-red-400">
                  This task blocks <span x-text="(selectedTask?.blocks_task_ids || []).length"></span> other task<span x-show="(selectedTask?.blocks_task_ids || []).length !== 1">s</span>:
                  <template x-for="(blockedId, index) in (selectedTask?.blocks_task_ids || [])" :key="blockedId">
                    <span>
                      <button
                        @click="openTaskById(blockedId)"
                        class="ml-1 text-blue-600 dark:text-blue-400 hover:underline cursor-pointer font-medium"
                        :title="`Click to view blocked task #${blockedId}`"
                        x-text="'#' + blockedId"
                      ></button><span x-show="index < (selectedTask?.blocks_task_ids || []).length - 1">,</span>
                    </span>
                  </template>
                </p>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400 italic">
                  Completing this task will unblock the listed tasks.
                </p>
              </div>

              <!-- Dependencies (tasks this depends on) -->
              <div class="mt-6" x-show="selectedTask?.depends_on && (() => { try { return JSON.parse(selectedTask.depends_on || '[]').length > 0; } catch { return false; } })()">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Dependencies</h3>
                <p class="mt-2 text-gray-600 dark:text-gray-400">
                  This task depends on:
                  <template x-for="(depId, index) in (() => { try { return JSON.parse(selectedTask?.depends_on || '[]'); } catch { return []; } })()" :key="depId">
                    <span>
                      <button
                        @click="openTaskById(depId)"
                        class="ml-1 text-blue-600 dark:text-blue-400 hover:underline cursor-pointer font-medium"
                        x-text="'#' + depId"
                      ></button><span x-show="index < (() => { try { return JSON.parse(selectedTask?.depends_on || '[]').length - 1; } catch { return 0; } })()">,</span>
                    </span>
                  </template>
                </p>
              </div>

              <!-- Subtasks (child tasks) -->
              <div class="mt-6" x-show="countSubtasks(selectedTask) > 0">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                  Subtasks (<span x-text="countSubtasks(selectedTask)"></span>)
                </h3>
                <div class="mt-2 space-y-2">
                  <template x-for="subtask in getSubtasks(selectedTask.id)" :key="subtask.id">
                    <button
                      @click="openTaskDetail(subtask)"
                      class="block w-full text-left px-3 py-2 bg-gray-50 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                    >
                      <span class="text-blue-600 dark:text-blue-400 font-medium" x-text="'#' + subtask.id"></span>
                      <span class="ml-2 text-gray-900 dark:text-gray-100" x-text="subtask.title"></span>
                      <span class="ml-2 text-xs text-gray-500" x-text="subtask.status"></span>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Metadata grid -->
              <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                <div>
                  <span class="font-semibold text-gray-700 dark:text-gray-300">Created:</span>
                  <span class="ml-2 text-gray-600 dark:text-gray-400" x-text="formatDate(selectedTask?.created_at)"></span>
                </div>

                <div x-show="selectedTask?.updated_at && selectedTask?.updated_at !== selectedTask?.created_at">
                  <span class="font-semibold text-gray-700 dark:text-gray-300">Updated:</span>
                  <span class="ml-2 text-gray-600 dark:text-gray-400" x-text="formatDate(selectedTask?.updated_at)"></span>
                </div>

                <div x-show="selectedTask?.completed_at">
                  <span class="font-semibold text-gray-700 dark:text-gray-300">Completed:</span>
                  <span class="ml-2 text-gray-600 dark:text-gray-400" x-text="formatDate(selectedTask?.completed_at)"></span>
                </div>

                <div x-show="selectedTask?.tags">
                  <span class="font-semibold text-gray-700 dark:text-gray-300">Tags:</span>
                  <span class="ml-2 text-gray-600 dark:text-gray-400" x-text="selectedTask?.tags || ''"></span>
                </div>

                <div x-show="selectedTask?.parent_task_id" class="sm:col-span-2">
                  <span class="font-semibold text-gray-700 dark:text-gray-300">Parent Task:</span>
                  <button
                    @click="openTaskById(selectedTask.parent_task_id)"
                    class="ml-2 text-blue-600 dark:text-blue-400 hover:underline cursor-pointer font-medium"
                    :title="`Click to view parent task #${selectedTask.parent_task_id}`"
                    x-text="'#' + (selectedTask?.parent_task_id || '')"
                  ></button>
                </div>
              </div>

              <!-- File references -->
              <div class="mt-6" x-show="selectedTask?.file_references && (() => { try { return JSON.parse(selectedTask.file_references || '[]').length > 0; } catch { return false; } })()">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">File References</h3>
                <ul class="mt-2 space-y-1">
                  <template x-for="file in (() => { try { return JSON.parse(selectedTask?.file_references || '[]'); } catch { return []; } })()" :key="file">
                    <li class="text-sm text-blue-600 dark:text-blue-400 font-mono" x-text="file || ''"></li>
                  </template>
                </ul>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- API Key Configuration Modal -->
    <div
      x-show="showApiKeyModal"
      x-cloak
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 overflow-y-auto"
      @click.self="showApiKeyModal = false"
      role="dialog"
      aria-modal="true"
      aria-labelledby="api-key-modal-title"
    >
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black bg-opacity-50"></div>

      <!-- Modal content -->
      <div class="flex min-h-full items-center justify-center p-4">
        <div
          x-show="showApiKeyModal"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
          x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
          x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
          x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
          class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6"
          @click.stop
        >
          <h2 id="api-key-modal-title" class="text-xl font-bold text-gray-900 dark:text-gray-100">Configure API Key</h2>

          <div class="mt-4">
            <label for="api-key-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              API Key
            </label>
            <input
              id="api-key-input"
              type="password"
              x-model="apiKeyInput"
              placeholder="Enter your API key"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div class="mt-6 flex gap-3">
            <button
              @click="saveApiKey()"
              class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
            >
              Save
            </button>
            <button
              @click="showApiKeyModal = false"
              class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Entity Detail Modal -->
    <div
      x-show="entityModalOpen"
      x-cloak
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 overflow-y-auto"
      @keydown.escape="closeEntityModal()"
      role="dialog"
      aria-modal="true"
      aria-labelledby="entity-modal-title"
    >
      <!-- Backdrop -->
      <div
        @click="closeEntityModal()"
        class="fixed inset-0 bg-black bg-opacity-50"
      ></div>

      <!-- Modal content -->
      <div class="flex min-h-full items-center justify-center p-4">
        <div
          x-show="entityModalOpen"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
          x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
          x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
          x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
          class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full p-6"
          @click.stop
          x-trap.noscroll="entityModalOpen"
        >
          <!-- Modal content (if entity selected) -->
          <template x-if="selectedEntity">
            <div>
              <!-- Header with close button -->
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h2 id="entity-modal-title" class="text-2xl font-bold text-gray-900 dark:text-gray-100" x-text="selectedEntity.name"></h2>
                  <div class="mt-1" x-html="getEntityTypeBadge(selectedEntity.entity_type)"></div>
                </div>
                <button
                  @click="closeEntityModal()"
                  class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                  aria-label="Close modal"
                >
                  <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <!-- Entity details grid -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Identifier -->
                <div>
                  <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Identifier</h3>
                  <p class="text-sm text-gray-900 dark:text-gray-100" x-text="selectedEntity.identifier || 'N/A'"></p>
                </div>

                <!-- Tags -->
                <div>
                  <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Tags</h3>
                  <template x-if="selectedEntity.tags">
                    <div class="flex flex-wrap gap-1">
                      <template x-for="tag in selectedEntity.tags.split(' ')" :key="tag">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200" x-text="tag"></span>
                      </template>
                    </div>
                  </template>
                  <template x-if="!selectedEntity.tags">
                    <p class="text-sm text-gray-500 dark:text-gray-400 italic">No tags</p>
                  </template>
                </div>

                <!-- Description (full width) -->
                <div class="md:col-span-2">
                  <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Description</h3>
                  <p class="text-sm text-gray-900 dark:text-gray-100 whitespace-pre-wrap" x-text="selectedEntity.description || 'No description'"></p>
                </div>
              </div>

              <!-- Metadata viewer -->
              <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Metadata</h3>
                  <button
                    @click="copyMetadata(selectedEntity.metadata)"
                    :disabled="!selectedEntity.metadata"
                    class="px-2 py-1 text-xs text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1"
                    title="Copy metadata to clipboard"
                  >
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Copy
                  </button>
                </div>

                <template x-if="selectedEntity.metadata">
                  <pre class="text-xs font-mono text-gray-800 dark:text-gray-200 overflow-x-auto whitespace-pre-wrap bg-gray-50 dark:bg-gray-900 rounded p-3 border border-gray-200 dark:border-gray-700"><code x-text="formatJSON(selectedEntity.metadata)"></code></pre>
                </template>

                <template x-if="!selectedEntity.metadata">
                  <p class="text-sm text-gray-500 dark:text-gray-400 italic">No metadata available</p>
                </template>
              </div>

              <!-- Linked tasks section -->
              <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">
                  Linked Tasks (<span x-text="entityTasks.length"></span>)
                </h3>

                <!-- Task list -->
                <template x-if="entityTasks.length > 0">
                  <div class="space-y-2">
                    <template x-for="task in entityTasks" :key="task.id">
                      <div
                        @click="closeEntityModal(); openTaskDetail(task)"
                        class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer border border-gray-200 dark:border-gray-600"
                        role="button"
                        tabindex="0"
                        @keydown.enter="closeEntityModal(); openTaskDetail(task)"
                        @keydown.space.prevent="closeEntityModal(); openTaskDetail(task)"
                      >
                        <div class="flex items-start justify-between gap-2">
                          <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate" x-text="task.title"></h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 line-clamp-2" x-text="task.description || 'No description'"></p>
                          </div>
                          <div class="flex flex-col gap-1 flex-shrink-0">
                            <!-- Status badge -->
                            <span
                              class="px-2 py-0.5 rounded text-xs font-medium text-center"
                              :class="{
                                'bg-slate-100 text-slate-800 dark:bg-slate-900 dark:text-slate-200': task.status === 'todo',
                                'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': task.status === 'in_progress',
                                'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': task.status === 'done',
                                'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': task.status === 'blocked',
                                'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200': task.status === 'to_be_deleted'
                              }"
                              x-text="task?.status ? task.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'"
                            ></span>

                            <!-- Priority badge -->
                            <span
                              class="px-2 py-0.5 rounded text-xs font-medium text-center"
                              :class="{
                                'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300': task.priority === 'low',
                                'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200': task.priority === 'medium',
                                'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': task.priority === 'high'
                              }"
                              x-text="task?.priority ? task.priority.charAt(0).toUpperCase() + task.priority.slice(1) : 'N/A'"
                            ></span>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>

                <!-- Empty state -->
                <template x-if="entityTasks.length === 0">
                  <div class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">No linked tasks</p>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- Expanded Detail Page View -->
    <div
      x-show="showDetailPage"
      x-cloak
      class="fixed inset-0 z-40 bg-white dark:bg-gray-900 overflow-y-auto"
    >
      <!-- Header with Back Button -->
      <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between">
        <button
          @click="closeDetailPage()"
          class="flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors"
        >
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span>Back to Tasks</span>
        </button>

        <div class="flex gap-2">
          <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            Edit
          </button>
          <button class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
            Delete
          </button>
        </div>
      </div>

      <!-- Main Content -->
      <template x-if="detailPageTask">
        <div class="max-w-5xl mx-auto px-6 py-8">
          <!-- Task Header -->
          <div class="mb-6">
            <div class="flex items-start gap-3 mb-3">
              <span class="text-gray-500 dark:text-gray-400 text-lg font-medium" x-text="'#' + detailPageTask.id"></span>
              <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 flex-1" x-text="detailPageTask.title"></h1>
            </div>

            <div class="flex gap-2 flex-wrap">
              <!-- Status Badge -->
              <span
                class="px-3 py-1 text-sm font-medium rounded-full"
                :class="{
                  'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200': detailPageTask.status === 'todo',
                  'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': detailPageTask.status === 'in_progress',
                  'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': detailPageTask.status === 'done',
                  'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': detailPageTask.status === 'blocked'
                }"
                x-text="detailPageTask.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"
              ></span>

              <!-- Priority Badge -->
              <span
                class="px-3 py-1 text-sm font-medium rounded"
                :class="{
                  'bg-gray-100 text-gray-700': detailPageTask.priority === 'low',
                  'bg-amber-100 text-amber-800': detailPageTask.priority === 'medium',
                  'bg-red-100 text-red-800': detailPageTask.priority === 'high'
                }"
                x-text="detailPageTask.priority.charAt(0).toUpperCase() + detailPageTask.priority.slice(1)"
              ></span>

              <!-- Tags -->
              <template x-if="detailPageTask.tags">
                <template x-for="tag in detailPageTask.tags.split(' ')" :key="tag">
                  <span class="px-2 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">
                    <span x-text="tag"></span>
                  </span>
                </template>
              </template>
            </div>
          </div>

          <!-- Description -->
          <div class="mb-8 bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Description</h2>
            <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap" x-text="detailPageTask.description || 'No description provided'"></p>
          </div>

          <!-- Metadata Grid -->
          <div class="mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
              <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Created</div>
              <div class="text-gray-900 dark:text-gray-100 font-medium" x-text="formatDate(detailPageTask.created_at)"></div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4" x-show="detailPageTask.updated_at !== detailPageTask.created_at">
              <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Updated</div>
              <div class="text-gray-900 dark:text-gray-100 font-medium" x-text="formatDate(detailPageTask.updated_at)"></div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4" x-show="detailPageTask.completed_at">
              <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Completed</div>
              <div class="text-gray-900 dark:text-gray-100 font-medium" x-text="formatDate(detailPageTask.completed_at)"></div>
            </div>
          </div>

          <!-- Related Tasks Table -->
          <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
              <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Related Tasks</h2>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-900">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      <button
                        @click="sortRelatedTasks('id')"
                        class="flex items-center gap-1 hover:text-gray-700 dark:hover:text-gray-200 transition-colors"
                      >
                        ID
                        <span x-show="relatedTasksSortColumn === 'id'">
                          <svg x-show="relatedTasksSortDirection === 'asc'" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                          </svg>
                          <svg x-show="relatedTasksSortDirection === 'desc'" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                          </svg>
                        </span>
                      </button>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      <button
                        @click="sortRelatedTasks('title')"
                        class="flex items-center gap-1 hover:text-gray-700 dark:hover:text-gray-200 transition-colors"
                      >
                        Title
                        <span x-show="relatedTasksSortColumn === 'title'">
                          <svg x-show="relatedTasksSortDirection === 'asc'" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                          </svg>
                          <svg x-show="relatedTasksSortDirection === 'desc'" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                          </svg>
                        </span>
                      </button>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      <button
                        @click="sortRelatedTasks('status')"
                        class="flex items-center gap-1 hover:text-gray-700 dark:hover:text-gray-200 transition-colors"
                      >
                        Status
                        <span x-show="relatedTasksSortColumn === 'status'">
                          <svg x-show="relatedTasksSortDirection === 'asc'" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                          </svg>
                          <svg x-show="relatedTasksSortDirection === 'desc'" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                          </svg>
                        </span>
                      </button>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      <button
                        @click="sortRelatedTasks('priority')"
                        class="flex items-center gap-1 hover:text-gray-700 dark:hover:text-gray-200 transition-colors"
                      >
                        Priority
                        <span x-show="relatedTasksSortColumn === 'priority'">
                          <svg x-show="relatedTasksSortDirection === 'asc'" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                          </svg>
                          <svg x-show="relatedTasksSortDirection === 'desc'" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                          </svg>
                        </span>
                      </button>
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Blocking</th>
                  </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                  <!-- Parent Task Row -->
                  <template x-if="detailPageRelatedTasks.parent">
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" @click="openTask(detailPageRelatedTasks.parent)">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center gap-1 text-indigo-600 dark:text-indigo-400 text-sm font-medium">
                          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                          </svg>
                          Parent
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 dark:text-blue-400 font-medium" x-text="'#' + detailPageRelatedTasks.parent.id"></td>
                      <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 dark:text-gray-100" x-text="detailPageRelatedTasks.parent.title"></div>
                        <div x-show="detailPageRelatedTasks.parent.description" class="text-xs text-gray-600 dark:text-gray-400 mt-1 line-clamp-2" x-text="detailPageRelatedTasks.parent.description"></div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span
                          class="px-2.5 py-0.5 rounded-full text-xs font-medium"
                          :class="{
                            'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200': detailPageRelatedTasks.parent.status === 'todo',
                            'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': detailPageRelatedTasks.parent.status === 'in_progress',
                            'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': detailPageRelatedTasks.parent.status === 'done',
                            'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': detailPageRelatedTasks.parent.status === 'blocked',
                            'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200': detailPageRelatedTasks.parent.status === 'to_be_deleted'
                          }"
                          x-text="detailPageRelatedTasks.parent.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"
                        ></span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span
                          class="px-2 py-0.5 rounded text-xs font-medium"
                          :class="{
                            'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300': detailPageRelatedTasks.parent.priority === 'low',
                            'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200': detailPageRelatedTasks.parent.priority === 'medium',
                            'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': detailPageRelatedTasks.parent.priority === 'high'
                          }"
                          x-text="detailPageRelatedTasks.parent.priority.charAt(0).toUpperCase() + detailPageRelatedTasks.parent.priority.slice(1)"
                        ></span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span x-show="detailPageRelatedTasks.parent.is_blocker" class="inline-flex items-center justify-center">
                          <svg class="h-4 w-4 text-red-600 dark:text-red-400" fill="currentColor" viewBox="0 0 20 20" title="This task blocks other tasks">
                            <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" />
                          </svg>
                        </span>
                      </td>
                    </tr>
                  </template>

                  <!-- Children Tasks -->
                  <template x-for="child in detailPageRelatedTasks.children" :key="child.id">
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" @click="openTask(child)">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center gap-1 text-purple-600 dark:text-purple-400 text-sm font-medium">
                          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                          </svg>
                          Child
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 dark:text-blue-400 font-medium" x-text="'#' + child.id"></td>
                      <td class="px-6 py-4">
                        <div class="flex items-center gap-2 text-sm text-gray-900 dark:text-gray-100">
                          <span class="text-gray-400 dark:text-gray-500">└─</span>
                          <span x-text="child.title"></span>
                        </div>
                        <div x-show="child.description" class="text-xs text-gray-600 dark:text-gray-400 mt-1 ml-6 line-clamp-2" x-text="child.description"></div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span
                          class="px-2.5 py-0.5 rounded-full text-xs font-medium"
                          :class="{
                            'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200': child.status === 'todo',
                            'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': child.status === 'in_progress',
                            'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': child.status === 'done',
                            'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': child.status === 'blocked',
                            'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200': child.status === 'to_be_deleted'
                          }"
                          x-text="child.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"
                        ></span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span
                          class="px-2 py-0.5 rounded text-xs font-medium"
                          :class="{
                            'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300': child.priority === 'low',
                            'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200': child.priority === 'medium',
                            'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': child.priority === 'high'
                          }"
                          x-text="child.priority.charAt(0).toUpperCase() + child.priority.slice(1)"
                        ></span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span x-show="child.is_blocker" class="inline-flex items-center justify-center">
                          <svg class="h-4 w-4 text-red-600 dark:text-red-400" fill="currentColor" viewBox="0 0 20 20" title="This task blocks other tasks">
                            <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" />
                          </svg>
                        </span>
                      </td>
                    </tr>
                  </template>

                  <!-- Dependencies -->
                  <template x-for="dep in detailPageRelatedTasks.dependencies" :key="dep.id">
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" @click="openTask(dep)">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center gap-1 text-amber-600 dark:text-amber-400 text-sm font-medium">
                          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                          </svg>
                          Depends
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 dark:text-blue-400 font-medium" x-text="'#' + dep.id"></td>
                      <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 dark:text-gray-100" x-text="dep.title"></div>
                        <div x-show="dep.description" class="text-xs text-gray-600 dark:text-gray-400 mt-1 line-clamp-2" x-text="dep.description"></div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span
                          class="px-2.5 py-0.5 rounded-full text-xs font-medium"
                          :class="{
                            'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200': dep.status === 'todo',
                            'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': dep.status === 'in_progress',
                            'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': dep.status === 'done',
                            'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': dep.status === 'blocked',
                            'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200': dep.status === 'to_be_deleted'
                          }"
                          x-text="dep.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"
                        ></span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span
                          class="px-2 py-0.5 rounded text-xs font-medium"
                          :class="{
                            'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300': dep.priority === 'low',
                            'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200': dep.priority === 'medium',
                            'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': dep.priority === 'high'
                          }"
                          x-text="dep.priority.charAt(0).toUpperCase() + dep.priority.slice(1)"
                        ></span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span x-show="dep.is_blocker" class="inline-flex items-center justify-center">
                          <svg class="h-4 w-4 text-red-600 dark:text-red-400" fill="currentColor" viewBox="0 0 20 20" title="This task blocks other tasks">
                            <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" />
                          </svg>
                        </span>
                      </td>
                    </tr>
                  </template>

                  <!-- Blocking -->
                  <template x-for="blocked in detailPageRelatedTasks.blocking" :key="blocked.id">
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" @click="openTask(blocked)">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center gap-1 text-red-600 dark:text-red-400 text-sm font-medium">
                          <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" />
                          </svg>
                          Blocks
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 dark:text-blue-400 font-medium" x-text="'#' + blocked.id"></td>
                      <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 dark:text-gray-100" x-text="blocked.title"></div>
                        <div x-show="blocked.description" class="text-xs text-gray-600 dark:text-gray-400 mt-1 line-clamp-2" x-text="blocked.description"></div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span
                          class="px-2.5 py-0.5 rounded-full text-xs font-medium"
                          :class="{
                            'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200': blocked.status === 'todo',
                            'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': blocked.status === 'in_progress',
                            'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': blocked.status === 'done',
                            'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': blocked.status === 'blocked',
                            'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200': blocked.status === 'to_be_deleted'
                          }"
                          x-text="blocked.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"
                        ></span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span
                          class="px-2 py-0.5 rounded text-xs font-medium"
                          :class="{
                            'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300': blocked.priority === 'low',
                            'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200': blocked.priority === 'medium',
                            'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': blocked.priority === 'high'
                          }"
                          x-text="blocked.priority.charAt(0).toUpperCase() + blocked.priority.slice(1)"
                        ></span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span x-show="blocked.is_blocker" class="inline-flex items-center justify-center">
                          <svg class="h-4 w-4 text-red-600 dark:text-red-400" fill="currentColor" viewBox="0 0 20 20" title="This task blocks other tasks">
                            <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" />
                          </svg>
                        </span>
                      </td>
                    </tr>
                  </template>

                  <!-- Empty State -->
                  <tr x-show="!detailPageRelatedTasks.parent && detailPageRelatedTasks.children.length === 0 && detailPageRelatedTasks.dependencies.length === 0 && detailPageRelatedTasks.blocking.length === 0">
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400 text-sm">
                      No related tasks
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- Toast Notification -->
    <div
      x-show="toast.show"
      x-cloak
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0 translate-y-2"
      x-transition:enter-end="opacity-100 translate-y-0"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100 translate-y-0"
      x-transition:leave-end="opacity-0 translate-y-2"
      class="fixed bottom-4 right-4 z-50 max-w-sm"
      role="alert"
      aria-live="polite"
    >
      <div
        class="rounded-lg shadow-lg p-4 border"
        :class="{
          'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800': toast.type === 'success',
          'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800': toast.type === 'error'
        }"
      >
        <div class="flex items-start">
          <!-- Success Icon -->
          <svg
            x-show="toast.type === 'success'"
            class="h-5 w-5 text-green-400 mt-0.5 flex-shrink-0"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>

          <!-- Error Icon -->
          <svg
            x-show="toast.type === 'error'"
            class="h-5 w-5 text-red-400 mt-0.5 flex-shrink-0"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>

          <div class="ml-3 flex-1">
            <p
              class="text-sm font-medium"
              :class="{
                'text-green-800 dark:text-green-200': toast.type === 'success',
                'text-red-800 dark:text-red-200': toast.type === 'error'
              }"
              x-text="toast.message"
            ></p>
          </div>

          <button
            @click="toast.show = false"
            class="ml-3 flex-shrink-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
          >
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- Alpine.js Application Logic -->
  <script>
    function taskViewer() {
      return {
        // State
        apiKey: API_CONFIG.getApiKey(),
        apiKeyInput: '',
        showApiKeyModal: false,
        projects: [],
        currentProject: null,
        tasks: [],
        filteredTasks: [],
        selectedTask: null,
        statusCounts: {
          total: 0,
          todo: 0,
          in_progress: 0,
          done: 0,
          blocked: 0,
          to_be_deleted: 0
        },

        // Hierarchy state
        expandedSubtasks: {},  // { taskId: boolean }
        subtasksCache: {},     // { taskId: subtasks[] }
        loadingSubtasks: {},   // { taskId: boolean }

        // Filters
        statusFilter: 'all',
        priorityFilter: 'all',
        searchQuery: '',
        sortBy: localStorage.getItem('taskSortBy') || 'priority_desc',
        sortOrder: localStorage.getItem('taskSortOrder') || 'desc',
        activeSmartFilter: null,
        tags: [],
        selectedTag: null,

        // UI State
        loading: false,
        error: null,
        showModal: false,
        refreshing: false,
        activeTab: 'tasks',  // 'tasks' | 'entities'
        toast: {
          show: false,
          type: 'success',
          message: ''
        },

        // Detail page state
        showDetailPage: false,
        detailPageTask: null,
        detailPageSubtasks: [],
        detailPageRelatedTasks: {
          parent: null,
          children: [],
          dependencies: [],
          blocking: []
        },
        relatedTasksSortColumn: null,
        relatedTasksSortDirection: 'asc',

        // Entities State
        entities: [],
        entityStats: {
          total: 0,
          file: 0,
          other: 0,
          top_tags: []
        },
        entitySearch: '',
        searchLoading: false,
        searchResultCount: 0,
        entityModalOpen: false,
        selectedEntity: null,
        entityTasks: [],
        entityFilters: {
          type: '',      // '' | 'file' | 'other'
          tags: [],      // array of selected tag strings
          limit: 25,     // Changed from 50 to 25 for pagination
          offset: 0
        },
        entityTags: [],  // available tags for entities
        selectedEntityTag: null,  // currently selected entity tag filter
        entitiesLoading: false,

        // Entity Pagination State
        entityCurrentPage: 1,
        entityTotalEntities: 0,
        entityTotalPages: 1,

        // Lifecycle
        async init() {
          // Set up global handler for nested subtask clicks
          window.__taskViewerOpenTask = (task) => this.openTaskDetail(task);

          // Handle URL hash for tab routing
          this.handleHashChange();
          window.addEventListener('hashchange', () => this.handleHashChange());

          // Check for API key
          if (!this.apiKey) {
            this.showApiKeyModal = true;
            return;
          }

          await this.loadProjects();
          if (this.projects.length > 0) {
            this.currentProject = this.projects[0];
            await this.loadTasks();
            await this.loadTags();
            await this.loadEntityStats();
            await this.loadEntities();
          }
        },

        // Hash routing handler
        handleHashChange() {
          const hash = window.location.hash.slice(1); // Remove '#'
          if (hash === 'entities') {
            this.activeTab = 'entities';
          } else {
            this.activeTab = 'tasks';
          }
        },

        // Switch tab and update URL hash
        switchTab(tab) {
          this.activeTab = tab;
          window.location.hash = tab === 'entities' ? '#entities' : '';
        },

        // API Methods
        async loadProjects() {
          this.loading = true;
          this.error = null;

          try {
            const response = await fetch(`${API_CONFIG.baseUrl}/projects`, {
              headers: { 'X-API-Key': this.apiKey }
            });

            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('Invalid API key. Please check your configuration.');
              }
              throw new Error(`Failed to load projects: ${response.statusText}`);
            }

            const data = await response.json();
            this.projects = data.projects || [];
          } catch (err) {
            this.error = err.message;
            console.error('Error loading projects:', err);
          } finally {
            this.loading = false;
          }
        },

        async loadTasks() {
          if (!this.currentProject) {
            this.tasks = [];
            this.filteredTasks = [];
            this.updateStatusCounts();
            return;
          }

          this.loading = true;
          this.error = null;

          try {
            const params = new URLSearchParams({
              project_id: this.currentProject.id,
              limit: '100',  // Increase limit to load more tasks (max is 100)
            });

            const response = await fetch(`${API_CONFIG.baseUrl}/tasks?${params}`, {
              headers: { 'X-API-Key': this.apiKey }
            });

            if (!response.ok) {
              throw new Error(`Failed to load tasks: ${response.statusText}`);
            }

            const data = await response.json();
            this.tasks = data.tasks || [];
            this.applyFilters();
          } catch (err) {
            this.error = err.message;
            this.tasks = [];
            this.filteredTasks = [];
            this.updateStatusCounts();
            console.error('Error loading tasks:', err);
          } finally {
            this.loading = false;
          }
        },

        async loadTags() {
          if (!this.currentProject) {
            this.tags = [];
            return;
          }

          try {
            const params = new URLSearchParams({
              project_id: this.currentProject.id,
            });

            const response = await fetch(`${API_CONFIG.baseUrl}/tags?${params}`, {
              headers: { 'X-API-Key': this.apiKey }
            });

            if (!response.ok) {
              throw new Error(`Failed to load tags: ${response.statusText}`);
            }

            const data = await response.json();
            this.tags = data.tags || [];
          } catch (err) {
            console.error('Error loading tags:', err);
            this.tags = [];
          }
        },

        async loadEntityStats() {
          if (!this.currentProject) {
            this.entityStats = { total: 0, file: 0, other: 0, top_tags: [] };
            return;
          }

          try {
            const params = new URLSearchParams({
              project_id: this.currentProject.id,
            });

            const response = await fetch(`${API_CONFIG.baseUrl}/entities/stats?${params}`, {
              headers: { 'X-API-Key': this.apiKey }
            });

            if (!response.ok) {
              throw new Error(`Failed to load entity stats: ${response.statusText}`);
            }

            const data = await response.json();
            this.entityStats = data.stats || { total: 0, file: 0, other: 0, top_tags: [] };
          } catch (err) {
            console.error('Error loading entity stats:', err);
            this.entityStats = { total: 0, file: 0, other: 0, top_tags: [] };
          }
        },

        async searchEntities() {
          if (!this.currentProject) {
            return;
          }

          // If search is empty, load all entities
          if (!this.entitySearch || this.entitySearch.trim() === '') {
            // TODO: Load all entities when list view is implemented
            this.entities = [];
            this.searchResultCount = 0;
            return;
          }

          this.searchLoading = true;

          try {
            const params = new URLSearchParams({
              project_id: this.currentProject.id,
              q: this.entitySearch,
              limit: '50'
            });

            const response = await fetch(`${API_CONFIG.baseUrl}/entities/search?${params}`, {
              headers: { 'X-API-Key': this.apiKey }
            });

            if (!response.ok) {
              throw new Error(`Failed to search entities: ${response.statusText}`);
            }

            const data = await response.json();
            this.entities = data.entities || [];
            this.searchResultCount = data.total || 0;
          } catch (err) {
            console.error('Search failed:', err);
            this.entities = [];
            this.searchResultCount = 0;
          } finally {
            this.searchLoading = false;
          }
        },

        clearEntitySearch() {
          this.entitySearch = '';
          this.searchResultCount = 0;
          this.entities = [];
          // TODO: Load all entities when list view is implemented
        },

        selectTag(tag) {
          this.selectedTag = tag;
          this.applyFilters();
        },

        async selectProject(project) {
          this.currentProject = project;
          this.selectedTag = null; // Clear tag filter when switching projects
          await this.loadTasks();
          await this.loadTags();
        },

        async refreshAllData() {
          if (this.refreshing) return;

          this.refreshing = true;
          this.error = null;

          try {
            // Clear caches
            this.subtasksCache = {};
            this.expandedSubtasks = {};
            this.loadingSubtasks = {};

            // Fetch projects with cache-busting
            const projectsResponse = await fetch(`${API_CONFIG.baseUrl}/projects?_t=${Date.now()}`, {
              headers: {
                'X-API-Key': this.apiKey,
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
              }
            });

            if (!projectsResponse.ok) {
              throw new Error(`Failed to refresh projects: ${projectsResponse.statusText}`);
            }

            const projectsData = await projectsResponse.json();
            this.projects = projectsData.projects || [];

            // Refresh tasks if a project is selected
            if (this.currentProject) {
              // Re-select current project to ensure it's still in the list
              const updatedProject = this.projects.find(p => p.id === this.currentProject.id);
              if (updatedProject) {
                this.currentProject = updatedProject;

                // Fetch tasks with cache-busting
                const params = new URLSearchParams({
                  project_id: this.currentProject.id,
                  limit: '100',  // Increase limit to load more tasks (max is 100)
                  _t: Date.now()  // Cache busting
                });

                const tasksResponse = await fetch(`${API_CONFIG.baseUrl}/tasks?${params}`, {
                  headers: {
                    'X-API-Key': this.apiKey,
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                  }
                });

                if (!tasksResponse.ok) {
                  throw new Error(`Failed to refresh tasks: ${tasksResponse.statusText}`);
                }

                const tasksData = await tasksResponse.json();
                this.tasks = tasksData.tasks || [];
                this.applyFilters();

                // Refresh tags as well
                await this.loadTags();
              } else {
                // Current project no longer exists
                this.currentProject = this.projects.length > 0 ? this.projects[0] : null;
                if (this.currentProject) {
                  await this.loadTasks();
                  await this.loadTags();
                } else {
                  this.tasks = [];
                  this.filteredTasks = [];
                  this.tags = [];
                  this.updateStatusCounts();
                }
              }
            }

            this.showToast('success', 'Data refreshed successfully');
          } catch (err) {
            this.error = err.message;
            this.showToast('error', `Refresh failed: ${err.message}`);
            console.error('Error refreshing data:', err);
          } finally {
            this.refreshing = false;
          }
        },

        showToast(type, message) {
          this.toast = {
            show: true,
            type,
            message
          };

          // Auto-hide after 3 seconds
          setTimeout(() => {
            this.toast.show = false;
          }, 3000);
        },

        // Entity Methods
        async loadEntities() {
          if (!this.currentProject) {
            this.entities = [];
            return;
          }

          this.entitiesLoading = true;

          try {
            const params = new URLSearchParams({
              project_id: this.currentProject.id,
              limit: this.entityFilters.limit.toString(),
              offset: this.entityFilters.offset.toString()
            });

            // Add type filter if set
            if (this.entityFilters.type) {
              params.append('entity_type', this.entityFilters.type);
            }

            // Add tag filter if set
            if (this.selectedEntityTag) {
              params.append('tags', this.selectedEntityTag);
            }

            const response = await fetch(`${API_CONFIG.baseUrl}/entities?${params}`, {
              headers: { 'X-API-Key': this.apiKey }
            });

            if (!response.ok) {
              throw new Error(`Failed to load entities: ${response.statusText}`);
            }

            const data = await response.json();
            this.entities = data.entities || [];
            this.entityTotalEntities = data.total || 0;
            this.entityTotalPages = Math.ceil(this.entityTotalEntities / this.entityFilters.limit);
          } catch (err) {
            console.error('Error loading entities:', err);
            this.entities = [];
            this.entityTotalEntities = 0;
            this.entityTotalPages = 1;
          } finally {
            this.entitiesLoading = false;
          }
        },

        selectEntityType(type) {
          this.entityFilters.type = type;
          this.entityFilters.offset = 0;
          this.entityCurrentPage = 1;
          this.loadEntities();
        },

        selectEntityTag(tag) {
          this.selectedEntityTag = tag;
          this.entityFilters.offset = 0;
          this.entityCurrentPage = 1;
          this.loadEntities();
        },

        clearEntityFilters() {
          this.entityFilters.type = '';
          this.selectedEntityTag = null;
          this.entityFilters.offset = 0;
          this.entityCurrentPage = 1;
          this.loadEntities();
        },

        // Entity pagination computed properties
        get entityPaginationStart() {
          return this.entityTotalEntities === 0 ? 0 : (this.entityCurrentPage - 1) * this.entityFilters.limit + 1;
        },

        get entityPaginationEnd() {
          return Math.min(this.entityCurrentPage * this.entityFilters.limit, this.entityTotalEntities);
        },

        get entityVisiblePages() {
          const pages = [];
          const total = this.entityTotalPages;
          const current = this.entityCurrentPage;

          // Show max 5 pages centered around current
          let start = Math.max(1, current - 2);
          let end = Math.min(total, start + 4);

          if (end - start < 4) {
            start = Math.max(1, end - 4);
          }

          for (let i = start; i <= end; i++) {
            pages.push(i);
          }

          return pages;
        },

        // Entity pagination navigation methods
        entityPreviousPage() {
          if (this.entityCurrentPage > 1) {
            this.entityCurrentPage--;
            this.loadEntitiesPage();
          }
        },

        entityNextPage() {
          if (this.entityCurrentPage < this.entityTotalPages) {
            this.entityCurrentPage++;
            this.loadEntitiesPage();
          }
        },

        entityGoToPage(page) {
          this.entityCurrentPage = page;
          this.loadEntitiesPage();
        },

        changeEntityPageSize() {
          this.entityCurrentPage = 1;
          this.loadEntitiesPage();
        },

        loadEntitiesPage() {
          this.entityFilters.offset = (this.entityCurrentPage - 1) * this.entityFilters.limit;
          this.loadEntities();

          // Scroll to top of entity list
          const container = document.getElementById('entities-container');
          if (container) {
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        },

        openEntityModal(entity) {
          this.selectedEntity = entity;
          this.entityModalOpen = true;
          this.loadEntityTasks(entity.id);
        },

        closeEntityModal() {
          this.entityModalOpen = false;
          setTimeout(() => {
            this.selectedEntity = null;
            this.entityTasks = [];
          }, 300);
        },

        async loadEntityTasks(entityId) {
          try {
            const params = new URLSearchParams({
              workspace_path: this.currentProject.workspace_path
            });

            const response = await fetch(
              `${API_CONFIG.getBaseUrl()}/api/entities/${entityId}/tasks?${params.toString()}`,
              {
                headers: {
                  'X-API-Key': API_CONFIG.getApiKey()
                }
              }
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            this.entityTasks = data.tasks || [];
          } catch (err) {
            console.error('Error loading entity tasks:', err);
            this.showToast('error', 'Failed to load entity tasks');
            this.entityTasks = [];
          }
        },
        // Smart Filter Methods
        applySmartFilter(filterName) {
          // Clear active smart filter when manually changing filters
          if (this.activeSmartFilter) {
            this.activeSmartFilter = null;
          }

          // Reset manual filters when applying smart filter
          this.statusFilter = 'all';
          this.priorityFilter = 'all';
          this.searchQuery = '';
          this.selectedTag = null;

          switch (filterName) {
            case 'my-focus':
              this.statusFilter = 'in_progress';
              this.priorityFilter = 'high';
              this.activeSmartFilter = 'my-focus';
              break;
            case 'ready-to-work':
              this.statusFilter = 'todo';
              this.activeSmartFilter = 'ready-to-work';
              break;
            case 'blocked-work':
              this.statusFilter = 'blocked';
              this.activeSmartFilter = 'blocked-work';
              break;
            case 'recently-completed':
              this.statusFilter = 'done';
              this.setSortBy('created');
              this.sortOrder = 'desc';
              this.activeSmartFilter = 'recently-completed';
              break;
            case 'parent-tasks':
              this.activeSmartFilter = 'parent-tasks';
              break;
            default:
              this.activeSmartFilter = null;
          }

          this.applyFilters();
        },

        clearSmartFilter() {
          this.activeSmartFilter = null;
          this.statusFilter = 'all';
          this.priorityFilter = 'all';
          this.searchQuery = '';
          this.selectedTag = null;
          this.applyFilters();
        },

        // Quick Actions (clipboard operations)
        async copyTaskId(task, event) {
          event.stopPropagation();
          try {
            await navigator.clipboard.writeText(String(task.id));
            this.showToast('success', `Task ID ${task.id} copied to clipboard`);
          } catch (err) {
            console.error('Failed to copy task ID:', err);
            this.showToast('error', 'Failed to copy task ID');
          }
        },

        async copyTaskDetails(task, event) {
          event.stopPropagation();
          try {
            const details = `Task #${task.id}: ${task.title}
Status: ${task.status}
Priority: ${task.priority}
${task.description ? 'Description: ' + task.description : ''}
Created: ${this.formatDate(task.created_at)}`;

            await navigator.clipboard.writeText(details);
            this.showToast('success', 'Task details copied to clipboard');
          } catch (err) {
            console.error('Failed to copy task details:', err);
            this.showToast('error', 'Failed to copy task details');
          }
        },

        // Filter Methods (client-side for instant response)
        applyFilters() {
          let filtered = [...(this.tasks || [])];

          // Status filter
          if (this.statusFilter !== 'all') {
            filtered = filtered.filter(t => t?.status === this.statusFilter);
          }

          // Priority filter
          if (this.priorityFilter !== 'all') {
            filtered = filtered.filter(t => t?.priority === this.priorityFilter);
          }

          // Tag filter
          if (this.selectedTag) {
            filtered = filtered.filter(t => {
              const tags = t?.tags ? t.tags.split(' ') : [];
              return tags.includes(this.selectedTag);
            });
          }

          // Smart filter specific logic
          if (this.activeSmartFilter === 'ready-to-work') {
            // Exclude blockers from "Ready to Work"
            filtered = filtered.filter(t => !t?.is_blocker && t?.status === 'todo');
          }

          if (this.activeSmartFilter === 'blocked-work') {
            // Include both blocked status AND blocker tasks
            filtered = this.tasks.filter(t => t?.status === 'blocked' || t?.is_blocker);
          }

          if (this.activeSmartFilter === 'parent-tasks') {
            // Show tasks that ARE parents (have at least one child task)
            const allTasks = this.tasks || [];
            filtered = filtered.filter(t => {
              // Count children for this task
              const childCount = allTasks.filter(child => child?.parent_task_id === t?.id).length;
              return childCount > 0;
            });
          }

          // Search filter
          if (this.searchQuery && this.searchQuery.trim()) {
            const query = this.searchQuery.toLowerCase();
            const queryAsNumber = parseInt(this.searchQuery, 10);
            filtered = filtered.filter(t =>
              (t?.title && t.title.toLowerCase().includes(query)) ||
              (t?.description && t.description.toLowerCase().includes(query)) ||
              (t?.tags && t.tags.toLowerCase().includes(query)) ||
              (t?.id && !isNaN(queryAsNumber) && t.id === queryAsNumber)
            );
          }

          // Sort
          this.sortTasks(filtered);

          this.filteredTasks = filtered;
          this.updateStatusCounts();
        },

        sortTasks(tasks) {
          const priorityOrder = { high: 3, medium: 2, low: 1 };
          const statusOrder = { todo: 1, in_progress: 2, blocked: 3, done: 4 };

          tasks.sort((a, b) => {
            let result = 0;

            // Extract sort type from sortBy (e.g., 'priority_desc' -> 'priority')
            const sortType = this.sortBy.split('_')[0];

            switch (sortType) {
              case 'priority':
                result = (priorityOrder[a?.priority] || 0) - (priorityOrder[b?.priority] || 0);
                break;
              case 'status':
                result = (statusOrder[a?.status] || 0) - (statusOrder[b?.status] || 0);
                break;
              case 'created':
                result = new Date(a?.created_at || 0) - new Date(b?.created_at || 0);
                break;
              case 'title':
                result = (a?.title || '').localeCompare(b?.title || '');
                break;
              case 'id':
                result = (a?.id || 0) - (b?.id || 0);
                break;
              default:
                return 0;
            }

            // Apply sort order (asc/desc)
            return this.sortOrder === 'desc' ? -result : result;
          });
        },

        setSortBy(sortType) {
          this.sortBy = sortType + '_' + this.sortOrder;
          localStorage.setItem('taskSortBy', this.sortBy);
          this.applyFilters();
        },

        toggleSortOrder() {
          this.sortOrder = this.sortOrder === 'desc' ? 'asc' : 'desc';
          localStorage.setItem('taskSortOrder', this.sortOrder);
          // Update sortBy to include new order
          const sortType = this.sortBy.split('_')[0];
          this.sortBy = sortType + '_' + this.sortOrder;
          localStorage.setItem('taskSortBy', this.sortBy);
          this.applyFilters();
        },

        // UI Methods
        openTaskDetail(task) {
          this.selectedTask = task;
          this.showModal = true;
        },

        closeModal() {
          this.showModal = false;
          setTimeout(() => {
            this.selectedTask = null;
          }, 300);
        },

        openTask(task) {
          this.selectedTask = task;
          this.showModal = true;
        },

        openDetailPage(task) {
          this.detailPageTask = task;
          this.showDetailPage = true;

          // Load related tasks
          this.loadRelatedTasks(task);

          // Hide main content
          document.body.style.overflow = 'hidden';
        },

        closeDetailPage() {
          this.showDetailPage = false;
          this.detailPageTask = null;
          this.detailPageRelatedTasks = {
            parent: null,
            children: [],
            dependencies: [],
            blocking: []
          };
          this.relatedTasksSortColumn = null;
          this.relatedTasksSortDirection = 'asc';
          document.body.style.overflow = '';
        },

        loadRelatedTasks(task) {
          const allTasks = this.tasks || [];

          // Parent task
          if (task.parent_task_id) {
            this.detailPageRelatedTasks.parent = allTasks.find(t => t.id === task.parent_task_id);
          }

          // Child tasks (subtasks)
          this.detailPageRelatedTasks.children = allTasks.filter(t => t.parent_task_id === task.id);

          // Dependencies
          if (task.depends_on) {
            try {
              const depIds = JSON.parse(task.depends_on);
              this.detailPageRelatedTasks.dependencies = allTasks.filter(t => depIds.includes(t.id));
            } catch (e) {
              this.detailPageRelatedTasks.dependencies = [];
            }
          }

          // Blocking tasks (tasks that depend on this task)
          this.detailPageRelatedTasks.blocking = allTasks.filter(t => {
            if (!t.depends_on) return false;
            try {
              const depIds = JSON.parse(t.depends_on);
              return depIds.includes(task.id);
            } catch (e) {
              return false;
            }
          });
        },

        sortRelatedTasks(column) {
          // Toggle sort direction if same column, otherwise set to ascending
          if (this.relatedTasksSortColumn === column) {
            this.relatedTasksSortDirection = this.relatedTasksSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            this.relatedTasksSortColumn = column;
            this.relatedTasksSortDirection = 'asc';
          }

          const direction = this.relatedTasksSortDirection;

          // Define sort comparator based on column
          const comparator = (a, b) => {
            let aVal, bVal;

            switch (column) {
              case 'id':
                aVal = a.id;
                bVal = b.id;
                break;
              case 'title':
                aVal = (a.title || '').toLowerCase();
                bVal = (b.title || '').toLowerCase();
                break;
              case 'status':
                // Order: todo -> in_progress -> blocked -> done -> to_be_deleted
                const statusOrder = { todo: 1, in_progress: 2, blocked: 3, done: 4, to_be_deleted: 5 };
                aVal = statusOrder[a.status] || 999;
                bVal = statusOrder[b.status] || 999;
                break;
              case 'priority':
                // Order: high -> medium -> low
                const priorityOrder = { high: 1, medium: 2, low: 3 };
                aVal = priorityOrder[a.priority] || 999;
                bVal = priorityOrder[b.priority] || 999;
                break;
              default:
                return 0;
            }

            // Compare values
            if (aVal < bVal) return direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return direction === 'asc' ? 1 : -1;
            return 0;
          };

          // Sort arrays and force Alpine.js reactivity by reassigning the entire object
          // This ensures Alpine's Proxy detects the change and re-renders the templates
          const sorted = {
            parent: this.detailPageRelatedTasks.parent,
            children: [...this.detailPageRelatedTasks.children].sort(comparator),
            dependencies: [...this.detailPageRelatedTasks.dependencies].sort(comparator),
            blocking: [...this.detailPageRelatedTasks.blocking].sort(comparator)
          };

          // Reassign the entire object to trigger reactivity
          this.detailPageRelatedTasks = sorted;
        },

        saveApiKey() {
          if (this.apiKeyInput && this.apiKeyInput.trim()) {
            this.apiKey = this.apiKeyInput.trim();
            API_CONFIG.setApiKey(this.apiKey);
            this.showApiKeyModal = false;
            this.apiKeyInput = '';
            this.init();
          }
        },

        // Update status counts
        updateStatusCounts() {
          const tasks = this.tasks || [];
          this.statusCounts = {
            total: tasks.length,
            todo: tasks.filter(t => t?.status === 'todo').length,
            in_progress: tasks.filter(t => t?.status === 'in_progress').length,
            done: tasks.filter(t => t?.status === 'done').length,
            blocked: tasks.filter(t => t?.status === 'blocked').length,
            to_be_deleted: tasks.filter(t => t?.status === 'to_be_deleted').length,
          };
        },

        // Helper Functions
        formatDate(dateString) {
          if (!dateString) return 'N/A';
          const date = new Date(dateString);
          return new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }).format(date);
        },

        formatRelativeTime(dateString) {
          if (!dateString) return 'N/A';
          const date = new Date(dateString);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);

          if (diffMins < 1) return 'Just now';
          if (diffMins < 60) return `${diffMins}m ago`;
          if (diffHours < 24) return `${diffHours}h ago`;
          if (diffDays < 7) return `${diffDays}d ago`;
          return this.formatDate(dateString);
        },

        calculatePercentage(count, total) {
          if (!total || total === 0) return 0;
          return Math.round((count / total) * 100);
        },

        // Metadata Helper Methods
        formatJSON(jsonString) {
          if (!jsonString) return '';
          try {
            const obj = JSON.parse(jsonString);
            return JSON.stringify(obj, null, 2);
          } catch (e) {
            return jsonString; // Return as-is if not valid JSON
          }
        },

        async copyMetadata(metadata) {
          if (!metadata) return;
          try {
            await navigator.clipboard.writeText(this.formatJSON(metadata));
            this.showToast('success', 'Metadata copied to clipboard');
          } catch (err) {
            console.error('Failed to copy metadata:', err);
            this.showToast('error', 'Failed to copy metadata');
          }
        },

        // Badge Helper Methods for Entity-Task Linking (Task #123)
        getStatusBadgeClasses(status) {
          const classMap = {
            'todo': 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200',
            'in_progress': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
            'done': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
            'blocked': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
            'to_be_deleted': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200'
          };
          return classMap[status] || classMap['todo'];
        },

        getPriorityBadgeClasses(priority) {
          const classMap = {
            'low': 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
            'medium': 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200',
            'high': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
          };
          return classMap[priority] || classMap['medium'];
        },

        formatStatus(status) {
          if (!status) return 'N/A';
          return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        },

        formatPriority(priority) {
          if (!priority) return 'N/A';
          return priority.charAt(0).toUpperCase() + priority.slice(1);
        },

        // Hierarchy Methods
        async toggleSubtasks(task, event) {
          // Note: event.stopPropagation() not needed because we use @click.stop in the template
          const taskId = task.id;

          // Toggle expansion state
          this.expandedSubtasks[taskId] = !this.expandedSubtasks[taskId];

          // If expanding and we don't have subtasks cached, fetch them
          if (this.expandedSubtasks[taskId] && !this.subtasksCache[taskId]) {
            this.loadingSubtasks[taskId] = true;

            try {
              const params = new URLSearchParams({
                project_id: this.currentProject.id,
              });

              const response = await fetch(`${API_CONFIG.baseUrl}/tasks/${taskId}/tree?${params}`, {
                headers: { 'X-API-Key': this.apiKey }
              });

              if (!response.ok) {
                throw new Error(`Failed to load subtasks: ${response.statusText}`);
              }

              const data = await response.json();
              // API returns task with 'subtasks' field containing nested subtasks array
              this.subtasksCache[taskId] = data?.subtasks || [];
            } catch (err) {
              console.error('Error loading subtasks:', err);
              this.showToast('error', `Failed to load subtasks: ${err.message}`);
              this.expandedSubtasks[taskId] = false;
            } finally {
              this.loadingSubtasks[taskId] = false;
            }
          }
        },

        getParentTask(parentId) {
          return this.tasks.find(t => t.id === parentId);
        },

        countSubtasks(task) {
          // If we've already loaded subtasks for this task via tree endpoint, use that count
          if (this.subtasksCache[task.id]) {
            return this.subtasksCache[task.id].length;
          }

          // Otherwise, count direct children in tasks array
          // Note: This may be inaccurate if pagination limit is reached
          return this.tasks.filter(t => t.parent_task_id === task.id).length;
        },

        getDependentTasks(dependsOn) {
          if (!dependsOn) return [];
          try {
            const depIds = typeof dependsOn === 'string' ? JSON.parse(dependsOn) : dependsOn;
            return depIds.map(id => this.tasks.find(t => t.id === id)).filter(Boolean);
          } catch {
            return [];
          }
        },

        getSubtasks(parentId) {
          // First check cache from tree endpoint
          if (this.subtasksCache[parentId]) {
            return this.subtasksCache[parentId];
          }
          // Fall back to filtering tasks array
          return this.tasks.filter(t => t.parent_task_id === parentId);
        },

        openTaskById(taskId) {
          const task = this.tasks.find(t => t.id === taskId);
          if (task) {
            this.openTaskDetail(task);
          } else {
            this.showToast('error', `Task #${taskId} not found`);
          }
        },

        // Entity type badge helper (returns badge HTML for entity types)
        // Usage in HTML string rendering: x-html="getEntityTypeBadge(entity.entity_type)"
        // Example: `<div>${this.getEntityTypeBadge('file')}</div>`
        getEntityTypeBadge(entityType) {
          const badgeConfigs = {
            'file': {
              bgClass: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
              icon: `<svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>`,
              label: 'file'
            },
            'other': {
              bgClass: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
              icon: `<svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>`,
              label: 'other'
            }
          };

          const config = badgeConfigs[entityType] || badgeConfigs['other'];
          return `
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.bgClass}">
              ${config.icon}
              ${config.label}
            </span>
          `;
        },

        // Entity type badge classes helper (for use with Alpine.js :class binding)
        // Usage in template: :class="getEntityTypeBadgeClasses(entity.entity_type)"
        // Example: <span class="badge" :class="getEntityTypeBadgeClasses(entity.entity_type)">
        getEntityTypeBadgeClasses(entityType) {
          const classMap = {
            'file': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
            'other': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200'
          };
          return classMap[entityType] || classMap['other'];
        },

        // Recursive subtask rendering with visual hierarchy
        renderSubtasksRecursive(subtasks, depth) {
          if (!subtasks || subtasks.length === 0) return '';

          const indent = depth * 16; // 16px per level
          const borderColor = depth === 0 ? 'border-purple-300 dark:border-purple-700' : 'border-purple-200 dark:border-purple-800';

          let html = `<div class="space-y-2 border-l-2 ${borderColor} pl-3" style="margin-left: ${indent}px;">`;

          for (const subtask of subtasks) {
            const statusClasses = {
              'todo': 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200',
              'in_progress': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
              'done': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
              'blocked': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
              'to_be_deleted': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200'
            };

            const priorityClasses = {
              'low': 'bg-gray-100 text-gray-700 dark:bg-gray-600 dark:text-gray-300',
              'medium': 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200',
              'high': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
            };

            const statusClass = statusClasses[subtask.status] || '';
            const priorityClass = priorityClasses[subtask.priority] || '';
            const statusText = subtask.status ? subtask.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A';
            const priorityText = subtask.priority || 'N/A';
            const hasChildren = subtask.subtasks && subtask.subtasks.length > 0;

            // Escape HTML in text fields
            const escapeHtml = (text) => {
              const div = document.createElement('div');
              div.textContent = text || '';
              return div.innerHTML;
            };

            const title = escapeHtml(subtask.title || 'Untitled');
            const description = escapeHtml(subtask.description || 'No description');

            // Store subtask data for onclick handler
            const subtaskDataAttr = `data-task-id="${subtask.id}" data-task='${JSON.stringify(subtask).replace(/'/g, '&#39;')}'`;

            html += `
              <div>
                <div
                  ${subtaskDataAttr}
                  onclick="window.__taskViewerOpenTask && window.__taskViewerOpenTask(JSON.parse(this.getAttribute('data-task')))"
                  class="bg-gray-50 dark:bg-gray-700/50 rounded p-2 border border-gray-200 dark:border-gray-600 hover:border-purple-400 dark:hover:border-purple-600 cursor-pointer transition-colors"
                >
                  <div class="flex items-start justify-between gap-2">
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2">
                        ${hasChildren ? `<span class="text-xs text-purple-600 dark:text-purple-400 font-medium" title="Has ${subtask.subtasks.length} subtask(s)">⎿</span>` : ''}
                        <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">${title}</h4>
                      </div>
                      <p class="text-xs text-gray-600 dark:text-gray-400 mt-1 line-clamp-1">${description}</p>
                    </div>
                    <span class="px-2 py-0.5 rounded-full text-xs font-medium flex-shrink-0 ${statusClass}">
                      ${statusText}
                    </span>
                  </div>
                  <div class="mt-1 flex items-center gap-2">
                    <span class="text-xs px-1.5 py-0.5 rounded ${priorityClass}">
                      ${priorityText}
                    </span>
                    ${subtask.is_blocker ? '<span class="inline-block w-2 h-2 bg-red-600 dark:bg-red-400 rounded-full" title="Blocks other tasks"></span>' : ''}
                    <span class="text-xs text-gray-400 dark:text-gray-500">Task #${subtask.id}</span>
                    ${hasChildren ? `<span class="text-xs text-purple-600 dark:text-purple-400">(${subtask.subtasks.length} subtask${subtask.subtasks.length !== 1 ? 's' : ''})</span>` : ''}
                  </div>
                </div>
                ${hasChildren ? this.renderSubtasksRecursive(subtask.subtasks, depth + 1) : ''}
              </div>
            `;
          }

          html += '</div>';
          return html;
        }
      }
    }
  </script>

  <!--
    ========================================
    METADATA VIEWER COMPONENT TEMPLATE
    ========================================

    Reusable template for displaying entity metadata with JSON formatting
    and copy-to-clipboard functionality.

    USAGE: Add this template wherever entity metadata needs to be displayed
    (e.g., in entity detail modals, entity cards with metadata preview).

    TEMPLATE:
    <div class="metadata-viewer bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
      <div class="flex justify-between items-center mb-3">
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Metadata</h4>
        <button
          @click="copyMetadata(entity.metadata)"
          class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium transition-colors flex items-center gap-1"
          :disabled="!entity.metadata"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          Copy
        </button>
      </div>

      <template x-if="entity.metadata">
        <pre class="text-xs font-mono text-gray-800 dark:text-gray-200 overflow-x-auto whitespace-pre-wrap bg-white dark:bg-gray-900 rounded p-3 border border-gray-200 dark:border-gray-700"><code x-text="formatJSON(entity.metadata)"></code></pre>
      </template>

      <template x-if="!entity.metadata">
        <p class="text-sm text-gray-500 dark:text-gray-400 italic">No metadata available</p>
      </template>
    </div>
  -->
</body>
</html>
